<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Dataset Handling
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="Deep.Net machine learning framework"/>
    <meta name="author" content="Deep.Net developers"/>

    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet"/>

    <link type="text/css" rel="stylesheet" href="http://www.deepml.net/content/style.css" />
    <script type="text/javascript" src="http://www.deepml.net/content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <![endif]-->

    <script type="text/javascript" async
              src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://github.com/DeepMLNet/DeepNet">github page</a></li>
        </ul>
        <h3 class="muted"><a href="http://www.deepml.net/index.html">Deep.Net</a></h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<h1><a name="Dataset-Handling" class="anchor" href="#Dataset-Handling">Dataset Handling</a></h1>
<p>Deep.Net provides a generic type for handling datasets used in machine learning.
It can handle samples that are of a user-defined record type containing fields of type ArrayNDT.
The following features are provided:</p>
<ul>
<li>data storage on host and CUDA GPU</li>
<li>indexed sample access</li>
<li>sample range access</li>
<li>mini-batch sequencing (with optional padding of last batch)</li>
<li>partitioning into training, validation and test set</li>
<li>loading from and saving to disk</li>
</ul>
<p>We are going to introduce it using a simple, synthetic dataset.</p>
<h2><a name="Creating-a-dataset" class="anchor" href="#Creating-a-dataset">Creating a dataset</a></h2>
<p>In most cases you are going to load a dataset by parsing some text or binary files.
However, since this is quite application-specific we do not want to concern ourselves with it here and will create a synthetic dataset using trigonometric functions on the fly.</p>
<h3><a name="Defining-the-sample-type" class="anchor" href="#Defining-the-sample-type">Defining the sample type</a></h3>
<p>Our sample type consists of two fields: a scalar <span class="math">\(x\)</span> and a vector <span class="math">\(\mathbf{v}\)</span>.
This corresponds to the following record type</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">open</span> <span class="i">ArrayNDNS</span>

<span class="k">type</span> <span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="t">MySampleType</span> <span class="o">=</span> {
    <span onmouseout="hideTip(event, 'fs2', 2)" onmouseover="showTip(event, 'fs2', 2)" class="i">X</span><span class="o">:</span>      <span class="i">ArrayNDT</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs3', 3)" onmouseover="showTip(event, 'fs3', 3)" class="i">single</span><span class="o">&gt;</span>
    <span onmouseout="hideTip(event, 'fs4', 4)" onmouseover="showTip(event, 'fs4', 4)" class="i">V</span><span class="o">:</span>      <span class="i">ArrayNDT</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs3', 5)" onmouseover="showTip(event, 'fs3', 5)" class="i">single</span><span class="o">&gt;</span>
}
</code></pre></td>
</tr>
</table>
<p>We use the data type <code>single</code> for fast arithmetic operations on the GPU.</p>
<h3><a name="Generating-some-samples" class="anchor" href="#Generating-some-samples">Generating some samples</a></h3>
<p>Next, let us generate some samples.
The scalar <span class="math">\(x\)</span> shall be sampled randomly from a uniform distribution on the interval <span class="math">\([-2, 2]\)</span>.
The values of vector <span class="math">\(v\)</span> shall be given by the relation</p>
<p><span class="math">\[\mathbf{v}(x) = \left( \begin{matrix} \mathrm{sinh} \, x \\ \mathrm{cosh} \, x \end{matrix} \right)\]</span></p>
<p>We can implement that using the following code.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
<span class="l">9: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs5', 6)" onmouseover="showTip(event, 'fs5', 6)" class="f">generateSamples</span> <span onmouseout="hideTip(event, 'fs6', 7)" onmouseover="showTip(event, 'fs6', 7)" class="i">cnt</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs7', 8)" onmouseover="showTip(event, 'fs7', 8)" class="i">seq</span> {
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs8', 9)" onmouseover="showTip(event, 'fs8', 9)" class="i">rng</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs9', 10)" onmouseover="showTip(event, 'fs9', 10)" class="i">System</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs10', 11)" onmouseover="showTip(event, 'fs10', 11)" class="t">Random</span> (<span class="n">100</span>)
    <span class="k">for</span> <span onmouseout="hideTip(event, 'fs11', 12)" onmouseover="showTip(event, 'fs11', 12)" class="i">n</span> <span class="o">=</span> <span class="n">0</span> <span class="k">to</span> <span onmouseout="hideTip(event, 'fs6', 13)" onmouseover="showTip(event, 'fs6', 13)" class="i">cnt</span> <span class="o">-</span> <span class="n">1</span> <span class="k">do</span>
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs12', 14)" onmouseover="showTip(event, 'fs12', 14)" class="i">x</span> <span class="o">=</span> <span class="n">2.</span> <span class="o">*</span> (<span onmouseout="hideTip(event, 'fs8', 15)" onmouseover="showTip(event, 'fs8', 15)" class="i">rng</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs13', 16)" onmouseover="showTip(event, 'fs13', 16)" class="f">NextDouble</span> () <span class="o">-</span> <span class="n">0.5</span>) <span class="o">*</span> <span class="n">2.</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs3', 17)" onmouseover="showTip(event, 'fs3', 17)" class="f">single</span>
        <span class="k">yield</span> {
            <span onmouseout="hideTip(event, 'fs2', 18)" onmouseover="showTip(event, 'fs2', 18)" class="i">X</span> <span class="o">=</span> <span class="i">ArrayNDHost</span><span class="o">.</span><span class="i">scalar</span> <span onmouseout="hideTip(event, 'fs12', 19)" onmouseover="showTip(event, 'fs12', 19)" class="i">x</span>
            <span onmouseout="hideTip(event, 'fs4', 20)" onmouseover="showTip(event, 'fs4', 20)" class="i">V</span> <span class="o">=</span> <span class="i">ArrayNDHost</span><span class="o">.</span><span class="i">ofList</span> [<span onmouseout="hideTip(event, 'fs14', 21)" onmouseover="showTip(event, 'fs14', 21)" class="i">sinh</span> <span onmouseout="hideTip(event, 'fs12', 22)" onmouseover="showTip(event, 'fs12', 22)" class="i">x</span>; <span onmouseout="hideTip(event, 'fs15', 23)" onmouseover="showTip(event, 'fs15', 23)" class="i">cosh</span> <span onmouseout="hideTip(event, 'fs12', 24)" onmouseover="showTip(event, 'fs12', 24)" class="i">x</span>]
        }    
}
</code></pre></td>
</tr>
</table>
<p>The generateSamples function produces the specified number of samples.
We can test it as follows.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs16', 25)" onmouseover="showTip(event, 'fs16', 25)" class="i">smpls</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs5', 26)" onmouseover="showTip(event, 'fs5', 26)" class="f">generateSamples</span> <span class="n">100</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs17', 27)" onmouseover="showTip(event, 'fs17', 27)" class="t">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs18', 28)" onmouseover="showTip(event, 'fs18', 28)" class="f">ofSeq</span>

<span class="k">for</span> <span onmouseout="hideTip(event, 'fs19', 29)" onmouseover="showTip(event, 'fs19', 29)" class="i">idx</span>, <span onmouseout="hideTip(event, 'fs20', 30)" onmouseover="showTip(event, 'fs20', 30)" class="i">smpl</span> <span class="k">in</span> <span onmouseout="hideTip(event, 'fs17', 31)" onmouseover="showTip(event, 'fs17', 31)" class="t">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs21', 32)" onmouseover="showTip(event, 'fs21', 32)" class="f">indexed</span> <span onmouseout="hideTip(event, 'fs16', 33)" onmouseover="showTip(event, 'fs16', 33)" class="i">smpls</span> <span class="k">do</span>
    <span onmouseout="hideTip(event, 'fs22', 34)" onmouseover="showTip(event, 'fs22', 34)" class="f">printfn</span> <span class="s">&quot;Sample </span><span class="pf">%3d</span><span class="s">: X=</span><span class="pf">%A</span><span class="s">    V=</span><span class="pf">%A</span><span class="s">&quot;</span> <span class="i">idx</span> <span onmouseout="hideTip(event, 'fs20', 35)" onmouseover="showTip(event, 'fs20', 35)" class="i">smpl</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 36)" onmouseover="showTip(event, 'fs2', 36)" class="i">X</span> <span onmouseout="hideTip(event, 'fs20', 37)" onmouseover="showTip(event, 'fs20', 37)" class="i">smpl</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 38)" onmouseover="showTip(event, 'fs4', 38)" class="i">V</span>
</code></pre></td>
</tr>
</table>
<p>This prints</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">Sample</span>   <span class="n">0</span><span class="o">:</span> <span class="i">X</span><span class="o">=</span>   <span class="n">1.8751</span>    <span class="i">V</span><span class="o">=</span>[   <span class="n">3.1841</span>    <span class="n">3.3374</span>]
<span class="i">Sample</span>   <span class="n">1</span><span class="o">:</span> <span class="i">X</span><span class="o">=</span>  <span class="o">-</span><span class="n">1.3633</span>    <span class="i">V</span><span class="o">=</span>[  <span class="o">-</span><span class="n">1.8265</span>    <span class="n">2.0824</span>]
<span class="i">Sample</span>   <span class="n">2</span><span class="o">:</span> <span class="i">X</span><span class="o">=</span>   <span class="n">0.6673</span>    <span class="i">V</span><span class="o">=</span>[   <span class="n">0.7179</span>    <span class="n">1.2310</span>]
<span class="i">Sample</span>   <span class="n">3</span><span class="o">:</span> <span class="i">X</span><span class="o">=</span>   <span class="n">1.6098</span>    <span class="i">V</span><span class="o">=</span>[   <span class="n">2.4010</span>    <span class="n">2.6009</span>]
<span class="o">..</span><span class="o">.</span>
<span class="i">Sample</span>  <span class="n">99</span><span class="o">:</span> <span class="i">X</span><span class="o">=</span>  <span class="o">-</span><span class="n">0.1610</span>    <span class="i">V</span><span class="o">=</span>[  <span class="o">-</span><span class="n">0.1617</span>    <span class="n">1.0130</span>]
</code></pre></td>
</tr>
</table>
<p>Now that we have some data, we can create a dataset.</p>
<h3><a name="Instantiating-the-dataset-type" class="anchor" href="#Instantiating-the-dataset-type">Instantiating the dataset type</a></h3>
<p>There are two ways to construct a dataset.</p>
<ol>
<li>The <code>Dataset&lt;'S&gt;.FromSamples</code> takes a sequence of samples (of type 'S) and constructs a dataset from them.</li>
<li>The <code>Dataset&lt;'S&gt;</code> constructor takes a list of ArrayNDTs corresponding to the fields of the record type 'S. The first dimension of each passed array must correspond to the sample index.</li>
</ol>
<p>Since we already have a sequence of sample, we use the first method.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">open</span> <span class="i">Datasets</span>

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs23', 39)" onmouseover="showTip(event, 'fs23', 39)" class="i">ds</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs16', 40)" onmouseover="showTip(event, 'fs16', 40)" class="i">smpls</span> <span class="o">|&gt;</span> <span class="i">Dataset</span><span class="o">.</span><span class="i">FromSamples</span>
</code></pre></td>
</tr>
</table>
<h2><a name="Accessing-single-and-multiple-elements" class="anchor" href="#Accessing-single-and-multiple-elements">Accessing single and multiple elements</a></h2>
<p>The dataset type supports the indexing and <a href="https://blogs.msdn.microsoft.com/chrsmith/2008/12/09/f-zen-array-slices/">slicing</a> operations to access samples.</p>
<p>When accessing a single sample using the indexing operator we obtain a record from the sequence of samples we passed into the <code>Dataset.FromSamples</code> methods.
For example to print the third sample we write</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs24', 41)" onmouseover="showTip(event, 'fs24', 41)" class="i">smpl2</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs23', 42)" onmouseover="showTip(event, 'fs23', 42)" class="i">ds</span><span class="o">.</span>[<span class="n">2</span>]
<span onmouseout="hideTip(event, 'fs22', 43)" onmouseover="showTip(event, 'fs22', 43)" class="f">printfn</span> <span class="s">&quot;Sample 3: X=</span><span class="pf">%A</span><span class="s">    V=</span><span class="pf">%A</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs24', 44)" onmouseover="showTip(event, 'fs24', 44)" class="i">smpl2</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 45)" onmouseover="showTip(event, 'fs2', 45)" class="i">X</span> <span onmouseout="hideTip(event, 'fs24', 46)" onmouseover="showTip(event, 'fs24', 46)" class="i">smpl2</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 47)" onmouseover="showTip(event, 'fs4', 47)" class="i">V</span>
</code></pre></td>
</tr>
</table>
<p>and get the output</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">Sample</span> <span class="n">3</span><span class="o">:</span> <span class="i">X</span><span class="o">=</span>   <span class="n">0.6673</span>    <span class="i">V</span><span class="o">=</span>[   <span class="n">0.7179</span>    <span class="n">1.2310</span>]
</code></pre></td>
</tr>
</table>
<p>When accessing multiple elements using the slicing operator, the returned value is of the same sample record type but the contained tensors have one additional dimension on the left corresponding to the sample index.
For example we can get a record containing the first three sample using the following code.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs25', 48)" onmouseover="showTip(event, 'fs25', 48)" class="i">smpl0to2</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs23', 49)" onmouseover="showTip(event, 'fs23', 49)" class="i">ds</span><span class="o">.</span>[<span class="n">0..</span><span class="n">2</span>]
<span onmouseout="hideTip(event, 'fs22', 50)" onmouseover="showTip(event, 'fs22', 50)" class="f">printfn</span> <span class="s">&quot;Samples 0,1,2:</span><span class="e">\n</span><span class="s">X=</span><span class="pf">%A</span><span class="s"></span><span class="e">\n</span><span class="s">V=</span><span class="e">\n</span><span class="s"></span><span class="pf">%A</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs25', 51)" onmouseover="showTip(event, 'fs25', 51)" class="i">smpl0to2</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 52)" onmouseover="showTip(event, 'fs2', 52)" class="i">X</span> <span onmouseout="hideTip(event, 'fs25', 53)" onmouseover="showTip(event, 'fs25', 53)" class="i">smpl0to2</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 54)" onmouseover="showTip(event, 'fs4', 54)" class="i">V</span>
</code></pre></td>
</tr>
</table>
<p>This prints</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">Samples</span> <span class="n">0</span>,<span class="n">1</span>,<span class="n">2</span><span class="o">:</span>
<span class="i">X</span><span class="o">=</span>[   <span class="n">1.8751</span>   <span class="o">-</span><span class="n">1.3633</span>    <span class="n">0.6673</span>]
<span class="i">V</span><span class="o">=</span>
[[   <span class="n">3.1841</span>    <span class="n">3.3374</span>]
 [  <span class="o">-</span><span class="n">1.8265</span>    <span class="n">2.0824</span>]
 [   <span class="n">0.7179</span>    <span class="n">1.2310</span>]]
</code></pre></td>
</tr>
</table>
<p>Hence all tensors in the sample record raise in rank by one dimension, i.e. the scalar <code>X</code> became a vector and the vector <code>V</code> became a matrix with each row corresponding to a sample.</p>
<h2><a name="Iterating-over-the-dataset" class="anchor" href="#Iterating-over-the-dataset">Iterating over the dataset</a></h2>
<p>You can also iterate over the samples of the dataset directly.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">for</span> <span onmouseout="hideTip(event, 'fs26', 55)" onmouseover="showTip(event, 'fs26', 55)" class="i">smpl</span> <span class="k">in</span> <span onmouseout="hideTip(event, 'fs23', 56)" onmouseover="showTip(event, 'fs23', 56)" class="i">ds</span> <span class="k">do</span>
    <span onmouseout="hideTip(event, 'fs22', 57)" onmouseover="showTip(event, 'fs22', 57)" class="f">printfn</span> <span class="s">&quot;Sample: </span><span class="pf">%A</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs26', 58)" onmouseover="showTip(event, 'fs26', 58)" class="i">smpl</span>
</code></pre></td>
</tr>
</table>
<p>This prints</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">Sample</span><span class="o">:</span> {<span class="i">X</span> <span class="o">=</span>    <span class="n">1.8751</span>;
 <span class="i">V</span> <span class="o">=</span> [   <span class="n">3.1841</span>    <span class="n">3.3374</span>];}
<span class="i">Sample</span><span class="o">:</span> {<span class="i">X</span> <span class="o">=</span>   <span class="o">-</span><span class="n">1.3633</span>;
 <span class="i">V</span> <span class="o">=</span> [  <span class="o">-</span><span class="n">1.8265</span>    <span class="n">2.0824</span>];}
<span class="i">Sample</span><span class="o">:</span> {<span class="i">X</span> <span class="o">=</span>    <span class="n">0.6673</span>;
 <span class="i">V</span> <span class="o">=</span> [   <span class="n">0.7179</span>    <span class="n">1.2310</span>];}
<span class="i">Sample</span><span class="o">:</span> {<span class="i">X</span> <span class="o">=</span>    <span class="n">1.6098</span>;
 <span class="i">V</span> <span class="o">=</span> [   <span class="n">2.4010</span>    <span class="n">2.6009</span>];}
<span class="o">..</span><span class="o">.</span>
<span class="i">Sample</span><span class="o">:</span> {<span class="i">X</span> <span class="o">=</span>   <span class="o">-</span><span class="n">0.1610</span>;
 <span class="i">V</span> <span class="o">=</span> [  <span class="o">-</span><span class="n">0.1617</span>    <span class="n">1.0130</span>];}
</code></pre></td>
</tr>
</table>
<h2><a name="Mini-batches" class="anchor" href="#Mini-batches">Mini-batches</a></h2>
<p>The <code>ds.Batches</code> function returns a sequence of mini-batches from the dataset.
It takes one argument specifying the number of samples in each batch.
If the total number of samples in the dataset is not a multiple of the batch size, the last batch will have less samples.</p>
<p>The following code prints the sizes of the obtained mini-batches.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">for</span> <span onmouseout="hideTip(event, 'fs19', 59)" onmouseover="showTip(event, 'fs19', 59)" class="i">idx</span>, <span onmouseout="hideTip(event, 'fs27', 60)" onmouseover="showTip(event, 'fs27', 60)" class="i">batch</span> <span class="k">in</span> <span onmouseout="hideTip(event, 'fs28', 61)" onmouseover="showTip(event, 'fs28', 61)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs29', 62)" onmouseover="showTip(event, 'fs29', 62)" class="f">indexed</span> (<span onmouseout="hideTip(event, 'fs23', 63)" onmouseover="showTip(event, 'fs23', 63)" class="i">ds</span><span class="o">.</span><span class="i">Batches</span> <span class="n">30</span>) <span class="k">do</span>
    <span onmouseout="hideTip(event, 'fs22', 64)" onmouseover="showTip(event, 'fs22', 64)" class="f">printfn</span> <span class="s">&quot;Batch </span><span class="pf">%d</span><span class="s">: shape of X: </span><span class="pf">%A</span><span class="s">    shape of V: </span><span class="pf">%A</span><span class="s">&quot;</span> 
        <span class="i">idx</span> <span onmouseout="hideTip(event, 'fs27', 65)" onmouseover="showTip(event, 'fs27', 65)" class="i">batch</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 66)" onmouseover="showTip(event, 'fs2', 66)" class="i">X</span><span class="o">.</span><span class="i">Shape</span> <span onmouseout="hideTip(event, 'fs27', 67)" onmouseover="showTip(event, 'fs27', 67)" class="i">batch</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 68)" onmouseover="showTip(event, 'fs4', 68)" class="i">V</span><span class="o">.</span><span class="i">Shape</span>
</code></pre></td>
</tr>
</table>
<p>This outputs</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">Batch</span> <span class="n">0</span><span class="o">:</span> <span class="i">shape</span> <span class="k">of</span> <span class="i">X</span><span class="o">:</span> [<span class="n">30</span>]    <span class="i">shape</span> <span class="k">of</span> <span class="i">V</span><span class="o">:</span> [<span class="n">30</span>; <span class="n">2</span>]
<span class="i">Batch</span> <span class="n">1</span><span class="o">:</span> <span class="i">shape</span> <span class="k">of</span> <span class="i">X</span><span class="o">:</span> [<span class="n">30</span>]    <span class="i">shape</span> <span class="k">of</span> <span class="i">V</span><span class="o">:</span> [<span class="n">30</span>; <span class="n">2</span>]
<span class="i">Batch</span> <span class="n">2</span><span class="o">:</span> <span class="i">shape</span> <span class="k">of</span> <span class="i">X</span><span class="o">:</span> [<span class="n">30</span>]    <span class="i">shape</span> <span class="k">of</span> <span class="i">V</span><span class="o">:</span> [<span class="n">30</span>; <span class="n">2</span>]
<span class="i">Batch</span> <span class="n">3</span><span class="o">:</span> <span class="i">shape</span> <span class="k">of</span> <span class="i">X</span><span class="o">:</span> [<span class="n">10</span>]    <span class="i">shape</span> <span class="k">of</span> <span class="i">V</span><span class="o">:</span> [<span class="n">10</span>; <span class="n">2</span>]
</code></pre></td>
</tr>
</table>
<p>If you need the last batch to be padded to the specified batch size, use the <code>ds.PaddedBatches</code> method instead.</p>
<h2><a name="Partitioning" class="anchor" href="#Partitioning">Partitioning</a></h2>
<p>It is often necessary to split a dataset into partitions.</p>
<p>The <code>ds.Partition</code> methods takes a list of ratios and returns a list of new datasets obtained by splitting the dataset according to the specified ratios.
Partitioning is done by sequentially taking samples from the beginning, until the first partition has the requested number of samples.
Then the samples for the second partition are taken and so on.</p>
<p>The following example splits our dataset into three partitions of ratios <span class="math">\(1/2\)</span>, <span class="math">\(1/4\)</span> and <span class="math">\(1/4\)</span>.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs30', 69)" onmouseover="showTip(event, 'fs30', 69)" class="i">partitions</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs23', 70)" onmouseover="showTip(event, 'fs23', 70)" class="i">ds</span><span class="o">.</span><span class="i">Partition</span> [<span class="n">0.5</span>; <span class="n">0.25</span>; <span class="n">0.25</span>]

<span class="k">for</span> <span onmouseout="hideTip(event, 'fs19', 71)" onmouseover="showTip(event, 'fs19', 71)" class="i">idx</span>, <span onmouseout="hideTip(event, 'fs31', 72)" onmouseover="showTip(event, 'fs31', 72)" class="i">p</span> <span class="k">in</span> <span onmouseout="hideTip(event, 'fs17', 73)" onmouseover="showTip(event, 'fs17', 73)" class="t">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs21', 74)" onmouseover="showTip(event, 'fs21', 74)" class="f">indexed</span> <span onmouseout="hideTip(event, 'fs30', 75)" onmouseover="showTip(event, 'fs30', 75)" class="i">partitions</span> <span class="k">do</span>
    <span onmouseout="hideTip(event, 'fs22', 76)" onmouseover="showTip(event, 'fs22', 76)" class="f">printfn</span> <span class="s">&quot;Partition </span><span class="pf">%d</span><span class="s"> has </span><span class="pf">%d</span><span class="s"> samples.&quot;</span> <span class="i">idx</span> <span onmouseout="hideTip(event, 'fs31', 77)" onmouseover="showTip(event, 'fs31', 77)" class="i">p</span><span class="o">.</span><span class="i">NSamples</span>
</code></pre></td>
</tr>
</table>
<p>This prints</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">Partition</span> <span class="n">0</span> <span class="i">has</span> <span class="n">50</span> <span class="i">samples</span><span class="o">.</span>
<span class="i">Partition</span> <span class="n">1</span> <span class="i">has</span> <span class="n">25</span> <span class="i">samples</span><span class="o">.</span>
<span class="i">Partition</span> <span class="n">2</span> <span class="i">has</span> <span class="n">25</span> <span class="i">samples</span><span class="o">.</span>
</code></pre></td>
</tr>
</table>
<h3><a name="Training-validation-and-test-splits" class="anchor" href="#Training-validation-and-test-splits">Training, validation and test splits</a></h3>
<p>In machine learning it is common practice to split the dataset into a training, validation and test dataset.
Deep.Net provides the <code>TrnValTst&lt;'S&gt;</code> type for that purpose.
It is a record type with the fields <code>Trn</code>, <code>Val</code> and <code>Tst</code> of type <code>Dataset&lt;'S&gt;</code>.
It can be constructed from an existing dataset using the <code>TrnValTst.Of</code> function.</p>
<p>The following code demonstrates its use using the ratios <span class="math">\(0.7\)</span>, <span class="math">\(0.15\)</span> and <span class="math">\(0.15\)</span> for the train, validation and test set respectively.
The ratio specification is optional; if it is omitted ratios of <span class="math">\(0.8\)</span>, <span class="math">\(0.1\)</span> and <span class="math">\(0.1\)</span> are used.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs32', 78)" onmouseover="showTip(event, 'fs32', 78)" class="i">dsp</span> <span class="o">=</span> <span class="i">TrnValTst</span><span class="o">.</span><span class="i">Of</span> (<span onmouseout="hideTip(event, 'fs23', 79)" onmouseover="showTip(event, 'fs23', 79)" class="i">ds</span>, <span class="n">0.7</span>, <span class="n">0.15</span>, <span class="n">0.15</span>)

<span onmouseout="hideTip(event, 'fs22', 80)" onmouseover="showTip(event, 'fs22', 80)" class="f">printfn</span> <span class="s">&quot;Training set size:    </span><span class="pf">%d</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs32', 81)" onmouseover="showTip(event, 'fs32', 81)" class="i">dsp</span><span class="o">.</span><span class="i">Trn</span><span class="o">.</span><span class="i">NSamples</span>
<span onmouseout="hideTip(event, 'fs22', 82)" onmouseover="showTip(event, 'fs22', 82)" class="f">printfn</span> <span class="s">&quot;Validation set size:  </span><span class="pf">%d</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs32', 83)" onmouseover="showTip(event, 'fs32', 83)" class="i">dsp</span><span class="o">.</span><span class="i">Val</span><span class="o">.</span><span class="i">NSamples</span>
<span onmouseout="hideTip(event, 'fs22', 84)" onmouseover="showTip(event, 'fs22', 84)" class="f">printfn</span> <span class="s">&quot;Test set size:        </span><span class="pf">%d</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs32', 85)" onmouseover="showTip(event, 'fs32', 85)" class="i">dsp</span><span class="o">.</span><span class="i">Tst</span><span class="o">.</span><span class="i">NSamples</span>
</code></pre></td>
</tr>
</table>
<p>This prints</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">Training</span> <span onmouseout="hideTip(event, 'fs33', 86)" onmouseover="showTip(event, 'fs33', 86)" class="i">set</span> <span class="i">size</span><span class="o">:</span>    <span class="n">70</span>
<span class="i">Validation</span> <span onmouseout="hideTip(event, 'fs33', 87)" onmouseover="showTip(event, 'fs33', 87)" class="i">set</span> <span class="i">size</span><span class="o">:</span>  <span class="n">15</span>
<span class="i">Test</span> <span onmouseout="hideTip(event, 'fs33', 88)" onmouseover="showTip(event, 'fs33', 88)" class="i">set</span> <span class="i">size</span><span class="o">:</span>        <span class="n">15</span>
</code></pre></td>
</tr>
</table>
<h2><a name="Data-transfer" class="anchor" href="#Data-transfer">Data transfer</a></h2>
<p>The <code>ds.ToCuda</code> and <code>ds.ToHost</code> methods copy the dataset to the CUDA GPU or to the host respectively.
The TrnValTst type provides the same methods.</p>
<h2><a name="Disk-storage" class="anchor" href="#Disk-storage">Disk storage</a></h2>
<p>Use the <code>ds.Save</code> method to save a dataset to disk using the HDF5 format.
The <code>Dataset&lt;'S&gt;.Load</code> function loads a saved dataset.
The TrnValTst type provides the same methods.</p>
<h1><a name="Dataset-loaders" class="anchor" href="#Dataset-loaders">Dataset loaders</a></h1>
<p>Currently Deep.Net provides the following loaders for common datasets.</p>
<ul>
<li><strong>MNIST</strong>. Use the <code>Mnist.load</code> function. It takes two parameters; the first is the path to the MNIST dataset (containing the files <code>t10k-images-idx3-ubyte.gz, t10k-labels-idx1-ubyte.gz, train-images-idx3-ubyte.gz, train-labels-idx1-ubyte.gz</code>) and the second is the desired ratio of the validation set to the training set (for example 0.166 if you want 50 000 training samples and 10 000 validation samples). The sample type <code>MnistT</code> contains two fields: <code>Img</code> for the flattened images and <code>Lbl</code> for the images in one-hot encoding.</li>
</ul>
<h1><a name="Summary" class="anchor" href="#Summary">Summary</a></h1>
<p>The <code>Dataset&lt;'S&gt;</code> type provides a convenient way to work with datasets.
Type-safety is provided by preserving the user-specified sample type <code>'S</code> when accessing individual or multiple samples.
The dataset handler is used by the <a href="training.html">generic training function</a>.</p>

<div class="tip" id="fs1">type MySampleType =<br />&#160;&#160;{X: obj;<br />&#160;&#160;&#160;V: obj;}<br /><br />Full name: Dataset.MySampleType</div>
<div class="tip" id="fs2">MySampleType.X: obj</div>
<div class="tip" id="fs3">Multiple items<br />val single : value:&#39;T -&gt; single (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.single<br /><br />--------------------<br />type single = System.Single<br /><br />Full name: Microsoft.FSharp.Core.single</div>
<div class="tip" id="fs4">MySampleType.V: obj</div>
<div class="tip" id="fs5">val generateSamples : cnt:int -&gt; seq&lt;MySampleType&gt;<br /><br />Full name: Dataset.generateSamples</div>
<div class="tip" id="fs6">val cnt : int</div>
<div class="tip" id="fs7">Multiple items<br />val seq : sequence:seq&lt;&#39;T&gt; -&gt; seq&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Core.Operators.seq<br /><br />--------------------<br />type seq&lt;&#39;T&gt; = System.Collections.Generic.IEnumerable&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.seq&lt;_&gt;</div>
<div class="tip" id="fs8">val rng : System.Random</div>
<div class="tip" id="fs9">namespace System</div>
<div class="tip" id="fs10">Multiple items<br />type Random =<br />&#160;&#160;new : unit -&gt; Random + 1 overload<br />&#160;&#160;member Next : unit -&gt; int + 2 overloads<br />&#160;&#160;member NextBytes : buffer:byte[] -&gt; unit<br />&#160;&#160;member NextDouble : unit -&gt; float<br /><br />Full name: System.Random<br /><br />--------------------<br />System.Random() : unit<br />System.Random(Seed: int) : unit</div>
<div class="tip" id="fs11">val n : int</div>
<div class="tip" id="fs12">val x : single</div>
<div class="tip" id="fs13">System.Random.NextDouble() : float</div>
<div class="tip" id="fs14">val sinh : value:&#39;T -&gt; &#39;T (requires member Sinh)<br /><br />Full name: Microsoft.FSharp.Core.Operators.sinh</div>
<div class="tip" id="fs15">val cosh : value:&#39;T -&gt; &#39;T (requires member Cosh)<br /><br />Full name: Microsoft.FSharp.Core.Operators.cosh</div>
<div class="tip" id="fs16">val smpls : MySampleType list<br /><br />Full name: Dataset.smpls</div>
<div class="tip" id="fs17">Multiple items<br />module List<br /><br />from Microsoft.FSharp.Collections<br /><br />--------------------<br />type List&lt;&#39;T&gt; =<br />&#160;&#160;| ( [] )<br />&#160;&#160;| ( :: ) of Head: &#39;T * Tail: &#39;T list<br />&#160;&#160;interface IEnumerable<br />&#160;&#160;interface IEnumerable&lt;&#39;T&gt;<br />&#160;&#160;member GetSlice : startIndex:int option * endIndex:int option -&gt; &#39;T list<br />&#160;&#160;member Head : &#39;T<br />&#160;&#160;member IsEmpty : bool<br />&#160;&#160;member Item : index:int -&gt; &#39;T with get<br />&#160;&#160;member Length : int<br />&#160;&#160;member Tail : &#39;T list<br />&#160;&#160;static member Cons : head:&#39;T * tail:&#39;T list -&gt; &#39;T list<br />&#160;&#160;static member Empty : &#39;T list<br /><br />Full name: Microsoft.FSharp.Collections.List&lt;_&gt;</div>
<div class="tip" id="fs18">val ofSeq : source:seq&lt;&#39;T&gt; -&gt; &#39;T list<br /><br />Full name: Microsoft.FSharp.Collections.List.ofSeq</div>
<div class="tip" id="fs19">val idx : int</div>
<div class="tip" id="fs20">val smpl : MySampleType</div>
<div class="tip" id="fs21">val indexed : list:&#39;T list -&gt; (int * &#39;T) list<br /><br />Full name: Microsoft.FSharp.Collections.List.indexed</div>
<div class="tip" id="fs22">val printfn : format:Printf.TextWriterFormat&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.printfn</div>
<div class="tip" id="fs23">val ds : seq&lt;obj&gt;<br /><br />Full name: Dataset.ds</div>
<div class="tip" id="fs24">val smpl2 : MySampleType<br /><br />Full name: Dataset.smpl2</div>
<div class="tip" id="fs25">val smpl0to2 : MySampleType<br /><br />Full name: Dataset.smpl0to2</div>
<div class="tip" id="fs26">val smpl : obj</div>
<div class="tip" id="fs27">val batch : MySampleType</div>
<div class="tip" id="fs28">module Seq<br /><br />from Microsoft.FSharp.Collections</div>
<div class="tip" id="fs29">val indexed : source:seq&lt;&#39;T&gt; -&gt; seq&lt;int * &#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.Seq.indexed</div>
<div class="tip" id="fs30">val partitions : obj list<br /><br />Full name: Dataset.partitions</div>
<div class="tip" id="fs31">val p : obj</div>
<div class="tip" id="fs32">val dsp : obj<br /><br />Full name: Dataset.dsp</div>
<div class="tip" id="fs33">val set : elements:seq&lt;&#39;T&gt; -&gt; Set&lt;&#39;T&gt; (requires comparison)<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.set</div>

        </div>
        <div class="span3">
          <!-- <img src="http://www.deepml.net/img/logo.png" alt="Deep.Net logo" style="width:150px;margin:10px" /> -->  
          <ul class="nav nav-list" id="menu" style="margin-top: 20px;">
            <li class="nav-header">Deep.Net</li>
            <li><a href="http://www.deepml.net/index.html">Home page</a></li>
            <li class="divider"></li>
            <li><a href="http://nuget.org/packages/DeepNet">Get Library via NuGet</a></li>
            <li><a href="http://github.com/DeepMLNet/DeepNet">Source Code on GitHub</a></li>
            <li><a href="http://www.deepml.net/release-notes.html">Release Notes</a></li>
            
            <li class="nav-header">Basics</li>
            <li><a href="http://www.deepml.net/tensor.html">Working with Tensors</a></li>
            <li><a href="http://www.deepml.net/model.html">Model Definition</a></li>
            <li><a href="http://www.deepml.net/components.html">Model Components</a></li>
            <li><a href="http://www.deepml.net/dataset.html">Dataset Handling</a></li>
            <li><a href="http://www.deepml.net/training.html">Training</a></li>

            <li class="nav-header">Advanced</li>
            <li><a href="http://www.deepml.net/diff.html">Automatic Differentiation</a></li>

            <li class="nav-header">Documentation</li>
            <li><a href="http://www.deepml.net/reference/index.html">API Reference</a></li>
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/DeepMLNet/DeepNet"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"/></a>
  </body>
  </html>
