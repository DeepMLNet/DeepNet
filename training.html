<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Generic Training
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="Deep.Net machine learning framework"/>
    <meta name="author" content="Deep.Net developers"/>

    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet"/>

    <link type="text/css" rel="stylesheet" href="file://C:\local\surban\dev\Deep\DeepNet\docs\tools\../output/content/style.css" />
    <script type="text/javascript" src="file://C:\local\surban\dev\Deep\DeepNet\docs\tools\../output/content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <![endif]-->

    <script type="text/javascript" async
              src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://github.com/DeepMLNet/DeepNet">github page</a></li>
        </ul>
        <h3 class="muted"><a href="file://C:\local\surban\dev\Deep\DeepNet\docs\tools\../output/index.html">Deep.Net</a></h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<h1><a name="Generic-Training" class="anchor" href="#Generic-Training">Generic Training</a></h1>
<p>Deep.Net contains a powerful, generic function to train your model.
Together with the <a href="dataset.html">dataset handler</a> it provides the following functionality:</p>
<ul>
<li>initialization of the model's parameters</li>
<li>mini-batch training</li>
<li>logging of losses on the training, validation and test sets</li>
<li>automatic scheduling of the learning rate</li>
<li>
termination of training when
<ul>
<li>a desired validation loss is reached</li>
<li>a set number of iterations have been performed</li>
<li>there is no loss improvement on the validation set within a set number of iterations</li>
</ul>
</li>
<li>checkpointing allows the training state to be saved to disk and training to be restarted afterwards (useful when running on non-reliable hardware or on a compute cluster that pauses jobs or moves them around on the cluster's nodes)</li>
</ul>
<h3><a name="Example-model" class="anchor" href="#Example-model">Example model</a></h3>
<p>To demonstrate its use we return to our two-layer neural network model for classifying MNIST digits.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="i">SymTensor</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 2)" onmouseover="showTip(event, 'fs1', 2)" class="i">SymTensor</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 3)" onmouseover="showTip(event, 'fs2', 3)" class="i">Compiler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 4)" onmouseover="showTip(event, 'fs3', 4)" class="i">Cuda</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs4', 5)" onmouseover="showTip(event, 'fs4', 5)" class="i">Models</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs5', 6)" onmouseover="showTip(event, 'fs5', 6)" class="i">Datasets</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs6', 7)" onmouseover="showTip(event, 'fs6', 7)" class="i">Optimizers</span>
</code></pre></td>
</tr>
</table>
<p>We load the MNIST dataset using the <code>Mnist.load</code> function using a validation to training ratio of 0.1.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs7', 8)" onmouseover="showTip(event, 'fs7', 8)" class="i">mnist</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs8', 9)" onmouseover="showTip(event, 'fs8', 9)" class="t">Mnist</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs9', 10)" onmouseover="showTip(event, 'fs9', 10)" class="f">load</span> (<span class="k">__SOURCE_DIRECTORY__</span> <span class="o">+</span> <span class="s">&quot;../../../Data/MNIST&quot;</span>) <span class="n">0.1</span>
            <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs10', 11)" onmouseover="showTip(event, 'fs10', 11)" class="t">TrnValTst</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs11', 12)" onmouseover="showTip(event, 'fs11', 12)" class="f">ToCuda</span>
</code></pre></td>
</tr>
</table>
<p>Next, we define and instantiate a model using the MLP (multi-layer perceptron, i.e. multi-layer neural network) component.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs12', 13)" onmouseover="showTip(event, 'fs12', 13)" class="i">mb</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs13', 14)" onmouseover="showTip(event, 'fs13', 14)" class="t">ModelBuilder</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs14', 15)" onmouseover="showTip(event, 'fs14', 15)" class="t">single</span><span class="o">&gt;</span> <span class="s">&quot;NeuralNetModel&quot;</span>

<span class="c">// define symbolic sizes</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs15', 16)" onmouseover="showTip(event, 'fs15', 16)" class="i">nBatch</span>  <span class="o">=</span> <span onmouseout="hideTip(event, 'fs12', 17)" onmouseover="showTip(event, 'fs12', 17)" class="i">mb</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs16', 18)" onmouseover="showTip(event, 'fs16', 18)" class="f">Size</span> <span class="s">&quot;nBatch&quot;</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs17', 19)" onmouseover="showTip(event, 'fs17', 19)" class="i">nInput</span>  <span class="o">=</span> <span onmouseout="hideTip(event, 'fs12', 20)" onmouseover="showTip(event, 'fs12', 20)" class="i">mb</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs16', 21)" onmouseover="showTip(event, 'fs16', 21)" class="f">Size</span> <span class="s">&quot;nInput&quot;</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs18', 22)" onmouseover="showTip(event, 'fs18', 22)" class="i">nClass</span>  <span class="o">=</span> <span onmouseout="hideTip(event, 'fs12', 23)" onmouseover="showTip(event, 'fs12', 23)" class="i">mb</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs16', 24)" onmouseover="showTip(event, 'fs16', 24)" class="f">Size</span> <span class="s">&quot;nClass&quot;</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs19', 25)" onmouseover="showTip(event, 'fs19', 25)" class="i">nHidden</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs12', 26)" onmouseover="showTip(event, 'fs12', 26)" class="i">mb</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs16', 27)" onmouseover="showTip(event, 'fs16', 27)" class="f">Size</span> <span class="s">&quot;nHidden&quot;</span>

<span class="c">// define model parameters</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs20', 28)" onmouseover="showTip(event, 'fs20', 28)" class="i">mlp</span> <span class="o">=</span> 
    <span onmouseout="hideTip(event, 'fs21', 29)" onmouseover="showTip(event, 'fs21', 29)" class="t">MLP</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs22', 30)" onmouseover="showTip(event, 'fs22', 30)" class="f">pars</span> (<span onmouseout="hideTip(event, 'fs12', 31)" onmouseover="showTip(event, 'fs12', 31)" class="i">mb</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs23', 32)" onmouseover="showTip(event, 'fs23', 32)" class="f">Module</span> <span class="s">&quot;MLP&quot;</span>) 
        { <span class="i">Layers</span> <span class="o">=</span> [{<span class="i">NInput</span><span class="o">=</span><span onmouseout="hideTip(event, 'fs17', 33)" onmouseover="showTip(event, 'fs17', 33)" class="i">nInput</span>; <span class="i">NOutput</span><span class="o">=</span><span onmouseout="hideTip(event, 'fs19', 34)" onmouseover="showTip(event, 'fs19', 34)" class="i">nHidden</span>; <span class="i">TransferFunc</span><span class="o">=</span><span onmouseout="hideTip(event, 'fs24', 35)" onmouseover="showTip(event, 'fs24', 35)" class="t">NeuralLayer</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs25', 36)" onmouseover="showTip(event, 'fs25', 36)" class="p">Tanh</span>}
                    {<span class="i">NInput</span><span class="o">=</span><span onmouseout="hideTip(event, 'fs19', 37)" onmouseover="showTip(event, 'fs19', 37)" class="i">nHidden</span>; <span class="i">NOutput</span><span class="o">=</span><span onmouseout="hideTip(event, 'fs18', 38)" onmouseover="showTip(event, 'fs18', 38)" class="i">nClass</span>; <span class="i">TransferFunc</span><span class="o">=</span><span onmouseout="hideTip(event, 'fs24', 39)" onmouseover="showTip(event, 'fs24', 39)" class="t">NeuralLayer</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs26', 40)" onmouseover="showTip(event, 'fs26', 40)" class="p">SoftMax</span>}]
          <span class="i">LossMeasure</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs27', 41)" onmouseover="showTip(event, 'fs27', 41)" class="t">LossLayer</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs28', 42)" onmouseover="showTip(event, 'fs28', 42)" class="p">CrossEntropy</span> }

<span class="c">// define variables</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs29', 43)" onmouseover="showTip(event, 'fs29', 43)" class="i">input</span>  <span class="o">:</span> <span onmouseout="hideTip(event, 'fs30', 44)" onmouseover="showTip(event, 'fs30', 44)" class="t">ExprT</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs14', 45)" onmouseover="showTip(event, 'fs14', 45)" class="t">single</span><span class="o">&gt;</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs12', 46)" onmouseover="showTip(event, 'fs12', 46)" class="i">mb</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs31', 47)" onmouseover="showTip(event, 'fs31', 47)" class="f">Var</span> <span class="s">&quot;Input&quot;</span>  [<span onmouseout="hideTip(event, 'fs15', 48)" onmouseover="showTip(event, 'fs15', 48)" class="i">nBatch</span>; <span onmouseout="hideTip(event, 'fs17', 49)" onmouseover="showTip(event, 'fs17', 49)" class="i">nInput</span>]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs32', 50)" onmouseover="showTip(event, 'fs32', 50)" class="i">target</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs30', 51)" onmouseover="showTip(event, 'fs30', 51)" class="t">ExprT</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs14', 52)" onmouseover="showTip(event, 'fs14', 52)" class="t">single</span><span class="o">&gt;</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs12', 53)" onmouseover="showTip(event, 'fs12', 53)" class="i">mb</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs31', 54)" onmouseover="showTip(event, 'fs31', 54)" class="f">Var</span> <span class="s">&quot;Target&quot;</span> [<span onmouseout="hideTip(event, 'fs15', 55)" onmouseover="showTip(event, 'fs15', 55)" class="i">nBatch</span>; <span onmouseout="hideTip(event, 'fs18', 56)" onmouseover="showTip(event, 'fs18', 56)" class="i">nClass</span>]

<span class="c">// instantiate model</span>
<span onmouseout="hideTip(event, 'fs12', 57)" onmouseover="showTip(event, 'fs12', 57)" class="i">mb</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs33', 58)" onmouseover="showTip(event, 'fs33', 58)" class="f">SetSize</span> <span onmouseout="hideTip(event, 'fs17', 59)" onmouseover="showTip(event, 'fs17', 59)" class="i">nInput</span> <span onmouseout="hideTip(event, 'fs7', 60)" onmouseover="showTip(event, 'fs7', 60)" class="i">mnist</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs34', 61)" onmouseover="showTip(event, 'fs34', 61)" class="i">Trn</span><span class="o">.</span>[<span class="n">0</span>]<span class="o">.</span><span class="i">Img</span><span class="o">.</span><span class="i">Shape</span><span class="o">.</span>[<span class="n">0</span>]
<span onmouseout="hideTip(event, 'fs12', 62)" onmouseover="showTip(event, 'fs12', 62)" class="i">mb</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs33', 63)" onmouseover="showTip(event, 'fs33', 63)" class="f">SetSize</span> <span onmouseout="hideTip(event, 'fs18', 64)" onmouseover="showTip(event, 'fs18', 64)" class="i">nClass</span> <span onmouseout="hideTip(event, 'fs7', 65)" onmouseover="showTip(event, 'fs7', 65)" class="i">mnist</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs34', 66)" onmouseover="showTip(event, 'fs34', 66)" class="i">Trn</span><span class="o">.</span>[<span class="n">0</span>]<span class="o">.</span><span class="i">Lbl</span><span class="o">.</span><span class="i">Shape</span><span class="o">.</span>[<span class="n">0</span>]
<span onmouseout="hideTip(event, 'fs12', 67)" onmouseover="showTip(event, 'fs12', 67)" class="i">mb</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs33', 68)" onmouseover="showTip(event, 'fs33', 68)" class="f">SetSize</span> <span onmouseout="hideTip(event, 'fs19', 69)" onmouseover="showTip(event, 'fs19', 69)" class="i">nHidden</span> <span class="n">100</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs35', 70)" onmouseover="showTip(event, 'fs35', 70)" class="i">mi</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs12', 71)" onmouseover="showTip(event, 'fs12', 71)" class="i">mb</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs36', 72)" onmouseover="showTip(event, 'fs36', 72)" class="f">Instantiate</span> <span onmouseout="hideTip(event, 'fs37', 73)" onmouseover="showTip(event, 'fs37', 73)" class="i">DevCuda</span>

<span class="c">// loss expression</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs38', 74)" onmouseover="showTip(event, 'fs38', 74)" class="i">loss</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs21', 75)" onmouseover="showTip(event, 'fs21', 75)" class="t">MLP</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs39', 76)" onmouseover="showTip(event, 'fs39', 76)" class="f">loss</span> <span onmouseout="hideTip(event, 'fs20', 77)" onmouseover="showTip(event, 'fs20', 77)" class="i">mlp</span> <span onmouseout="hideTip(event, 'fs29', 78)" onmouseover="showTip(event, 'fs29', 78)" class="i">input</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs40', 79)" onmouseover="showTip(event, 'fs40', 79)" class="i">T</span> <span onmouseout="hideTip(event, 'fs32', 80)" onmouseover="showTip(event, 'fs32', 80)" class="i">target</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs40', 81)" onmouseover="showTip(event, 'fs40', 81)" class="i">T</span>
</code></pre></td>
</tr>
</table>
<p>Note that the input and target matrices must be transposed, since the neural network model expects each sample to be a column in the matrix while the dataset provides a matrix where each row is a sample.</p>
<p>We instantiate the <a href="https://arxiv.org/abs/1412.6980">Adam</a> optimizer to minimize the loss and use its default configuration.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">// optimizer</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs41', 82)" onmouseover="showTip(event, 'fs41', 82)" class="i">opt</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs42', 83)" onmouseover="showTip(event, 'fs42', 83)" class="t">Adam</span> (<span onmouseout="hideTip(event, 'fs38', 84)" onmouseover="showTip(event, 'fs38', 84)" class="i">loss</span>, <span onmouseout="hideTip(event, 'fs35', 85)" onmouseover="showTip(event, 'fs35', 85)" class="i">mi</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs43', 86)" onmouseover="showTip(event, 'fs43', 86)" class="i">ParameterVector</span>, <span onmouseout="hideTip(event, 'fs37', 87)" onmouseover="showTip(event, 'fs37', 87)" class="i">DevCuda</span>)
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs44', 88)" onmouseover="showTip(event, 'fs44', 88)" class="i">optCfg</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs41', 89)" onmouseover="showTip(event, 'fs41', 89)" class="i">opt</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs45', 90)" onmouseover="showTip(event, 'fs45', 90)" class="i">DefaultCfg</span>
</code></pre></td>
</tr>
</table>
<p>In previous example we have written a simple optimization loop by hand.
Here instead, we will employ the generic training function provided by Deep.Net.</p>
<h2><a name="Defining-a-Trainable" class="anchor" href="#Defining-a-Trainable">Defining a Trainable</a></h2>
<p>The generic training function works on any object that implements the <code>Train.ITrainable&lt;'Smpl, 'T&gt;</code> interface where <code>'Smpl</code> is a sample record type (see <a href="dataset.html">dataset handling</a>) and <code>'T</code> is the data type of the model parameters, e.g. <code>single</code>.
The easiest way to create an ITrainable from a symbolic loss expression is to use the <code>Train.trainableFromLossExpr</code> function.
This function has the signature</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">val</span> <span class="i">trainableFromLossExpr</span> <span class="o">:</span> <span class="i">modelInstance</span><span class="o">:</span><span class="i">ModelInstance</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">T</span><span class="o">&gt;</span> <span class="k">-&gt;</span> 
                            <span class="i">loss</span><span class="o">:</span><span class="i">ExprT</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">T</span><span class="o">&gt;</span> <span class="k">-&gt;</span> 
                            <span class="i">varEnvBuilder</span><span class="o">:</span>(<span class="o">&#39;</span><span class="i">Smpl</span> <span class="k">-&gt;</span> <span class="i">VarEnvT</span>) <span class="k">-&gt;</span> 
                            <span class="i">optimizer</span><span class="o">:</span><span class="i">IOptimizer</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">T</span>,<span class="o">&#39;</span><span class="i">OptCfg</span>,<span class="o">&#39;</span><span class="i">OptState</span><span class="o">&gt;</span> <span class="k">-&gt;</span> 
                            <span class="i">optCfg</span><span class="o">:</span><span class="o">&#39;</span><span class="i">OptCfg</span> <span class="k">-&gt;</span> 
                            <span class="i">ITrainable</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">Smpl</span>,<span class="o">&#39;</span><span class="i">T</span><span class="o">&gt;</span> 
</code></pre></td>
</tr>
</table>
<p>The arguments have the following meaning.</p>
<ul>
<li><code>modelInstance</code> is the model instance containing the parameters of the model to be trained.</li>
<li><code>loss</code> is the loss expression to be minimized.</li>
<li><code>varEnvBuilder</code> is a user-provided function that takes an instance of user-provided type <code>'Smpl</code> and returns a variable environment to evaluate the loss expression on this sample(s). The sample below shows how to build a variable environment from a sample.</li>
<li><code>optimizer</code> is an instance of an optimizer. All optimizers in Deep.Net implement the <code>IOptimizer</code> interface.</li>
<li><code>optCfg</code> is the optimizer configuration to use. The learning rate in the specified optimizer configuration will be overwritten.</li>
</ul>
<p>Let us build a trainable for our model.
First, we need to define a function that creates a variable environment from a sample.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs46', 91)" onmouseover="showTip(event, 'fs46', 91)" class="f">smplVarEnv</span> (<span onmouseout="hideTip(event, 'fs47', 92)" onmouseover="showTip(event, 'fs47', 92)" class="i">smpl</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs48', 93)" onmouseover="showTip(event, 'fs48', 93)" class="t">MnistT</span>) <span class="o">=</span>
    <span onmouseout="hideTip(event, 'fs49', 94)" onmouseover="showTip(event, 'fs49', 94)" class="t">VarEnv</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs50', 95)" onmouseover="showTip(event, 'fs50', 95)" class="i">empty</span>
    <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs49', 96)" onmouseover="showTip(event, 'fs49', 96)" class="t">VarEnv</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs51', 97)" onmouseover="showTip(event, 'fs51', 97)" class="f">add</span> <span onmouseout="hideTip(event, 'fs29', 98)" onmouseover="showTip(event, 'fs29', 98)" class="i">input</span> <span onmouseout="hideTip(event, 'fs47', 99)" onmouseover="showTip(event, 'fs47', 99)" class="i">smpl</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs52', 100)" onmouseover="showTip(event, 'fs52', 100)" class="i">Img</span>
    <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs49', 101)" onmouseover="showTip(event, 'fs49', 101)" class="t">VarEnv</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs51', 102)" onmouseover="showTip(event, 'fs51', 102)" class="f">add</span> <span onmouseout="hideTip(event, 'fs32', 103)" onmouseover="showTip(event, 'fs32', 103)" class="i">target</span> <span onmouseout="hideTip(event, 'fs47', 104)" onmouseover="showTip(event, 'fs47', 104)" class="i">smpl</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs53', 105)" onmouseover="showTip(event, 'fs53', 105)" class="i">Lbl</span>
</code></pre></td>
</tr>
</table>
<p>The value of the symbolic variable <code>input</code> is set to the image of the MNIST sample and the symbolic variable <code>target</code> is set to the label in one-hot encoding.</p>
<p>We are now ready to construct the trainable.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs54', 106)" onmouseover="showTip(event, 'fs54', 106)" class="i">trainable</span> <span class="o">=</span>
    <span onmouseout="hideTip(event, 'fs55', 107)" onmouseover="showTip(event, 'fs55', 107)" class="t">Train</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs56', 108)" onmouseover="showTip(event, 'fs56', 108)" class="f">trainableFromLossExpr</span> <span onmouseout="hideTip(event, 'fs35', 109)" onmouseover="showTip(event, 'fs35', 109)" class="i">mi</span> <span onmouseout="hideTip(event, 'fs38', 110)" onmouseover="showTip(event, 'fs38', 110)" class="i">loss</span> <span onmouseout="hideTip(event, 'fs46', 111)" onmouseover="showTip(event, 'fs46', 111)" class="f">smplVarEnv</span> <span onmouseout="hideTip(event, 'fs41', 112)" onmouseover="showTip(event, 'fs41', 112)" class="i">opt</span> <span onmouseout="hideTip(event, 'fs44', 113)" onmouseover="showTip(event, 'fs44', 113)" class="i">optCfg</span>
</code></pre></td>
</tr>
</table>
<h2><a name="Training-configuration" class="anchor" href="#Training-configuration">Training configuration</a></h2>
<p>Next, we need to specify the training configuration using the <code>Train.Cfg</code> record type.
For illustration purposes we write down the whole record instance; in practice you would copy <code>Train.defaultCfg</code> and change fields as necessary.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs57', 114)" onmouseover="showTip(event, 'fs57', 114)" class="i">trainCfg</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs55', 115)" onmouseover="showTip(event, 'fs55', 115)" class="t">Train</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs58', 116)" onmouseover="showTip(event, 'fs58', 116)" class="t">Cfg</span> <span class="o">=</span> {    
    <span class="i">Seed</span>               <span class="o">=</span> <span class="n">100</span>   
    <span class="i">BatchSize</span>          <span class="o">=</span> <span class="n">10000</span> 
    <span class="i">LossRecordInterval</span> <span class="o">=</span> <span class="n">10</span>                                   
    <span class="i">Termination</span>        <span class="o">=</span> <span onmouseout="hideTip(event, 'fs55', 117)" onmouseover="showTip(event, 'fs55', 117)" class="t">Train</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs59', 118)" onmouseover="showTip(event, 'fs59', 118)" class="p">ItersWithoutImprovement</span> <span class="n">100</span>
    <span class="i">MinImprovement</span>     <span class="o">=</span> <span class="n">1e-7</span>  
    <span class="i">TargetLoss</span>         <span class="o">=</span> <span onmouseout="hideTip(event, 'fs60', 119)" onmouseover="showTip(event, 'fs60', 119)" class="p">None</span>  
    <span class="i">MinIters</span>           <span class="o">=</span> <span onmouseout="hideTip(event, 'fs61', 120)" onmouseover="showTip(event, 'fs61', 120)" class="p">Some</span> <span class="n">100</span> 
    <span class="i">MaxIters</span>           <span class="o">=</span> <span onmouseout="hideTip(event, 'fs60', 121)" onmouseover="showTip(event, 'fs60', 121)" class="p">None</span>  
    <span class="i">LearningRates</span>      <span class="o">=</span> [<span class="n">1e-3</span>; <span class="n">1e-4</span>; <span class="n">1e-5</span>]                               
    <span class="i">CheckpointDir</span>      <span class="o">=</span> <span onmouseout="hideTip(event, 'fs60', 122)" onmouseover="showTip(event, 'fs60', 122)" class="p">None</span>  
    <span class="i">DiscardCheckpoint</span>  <span class="o">=</span> <span class="k">false</span> 
} 
</code></pre></td>
</tr>
</table>
<p>The meaning of the fields is as follows.</p>
<ul>
<li><strong>Seed</strong> is the random seed for model parameter initialization.</li>
<li><strong>BatchSize</strong> is the size of mini-batches used for training and evaluating the losses.</li>
<li><strong>LossRecordInterval</strong> is the number of iterations to perform between evaluating the loss on the validation and test sets.</li>
<li>
<strong>Termination</strong> is the termination criterium and can have the following values:
<ul>
<li><code>Train.ItersWithImprovements cnt</code> to stop training after <code>cnt</code> iteraitons without improvement.</li>
<li><code>Train.IterGain gain</code> to train for <span class="math">\(\mathrm{gain} \cdot \mathrm{bestIter}\)</span> iterations where <span class="math">\(\mathrm{bestIter}\)</span> is the best iteration. Usually one would use <span class="math">\(\mathrm{gain} \approx 2.0\)</span>.</li>
<li><code>Train.Forever</code> disables the termination criterium.</li>
</ul>
</li>
<li><strong>MinImprovement</strong> is the minimum loss change to count as improvement and should be a small number.</li>
<li><strong>TargetLoss</strong> can be used to specify a target validation loss that stops training when achieved. Use <code>Some loss</code> or <code>None</code>.</li>
<li><strong>MinIters</strong> can be the minimum number of training iterations to perform in the form <code>Some iters</code>, or <code>None</code>.</li>
<li><strong>MaxIters</strong> can be a hard limit on the training iterations in the form <code>Some iters</code>, or <code>None</code>.</li>
<li><strong>LearningRates</strong> is a list of learning rates to use. Training starts with the first element and moves to the next one, when the termination criterium (specified by the field Termination) is triggered.</li>
<li><strong>CheckpointDir</strong> may specify a directory in the form <code>Some dir</code>. (see checkpoint section for details)</li>
<li><strong>DiscardCheckpoint</strong> prohibits loading of a checkpoint if it is <code>true</code>.</li>
</ul>
<h2><a name="Performing-the-training" class="anchor" href="#Performing-the-training">Performing the training</a></h2>
<p>Now training can be performed by calling the <code>Train.train</code> function.
It takes three arguments: a trainable, the dataset to use and the training configuration.
The dataset was already loaded above.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs62', 123)" onmouseover="showTip(event, 'fs62', 123)" class="i">result</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs55', 124)" onmouseover="showTip(event, 'fs55', 124)" class="t">Train</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs63', 125)" onmouseover="showTip(event, 'fs63', 125)" class="f">train</span> <span onmouseout="hideTip(event, 'fs54', 126)" onmouseover="showTip(event, 'fs54', 126)" class="i">trainable</span> <span onmouseout="hideTip(event, 'fs7', 127)" onmouseover="showTip(event, 'fs7', 127)" class="i">mnist</span> <span onmouseout="hideTip(event, 'fs57', 128)" onmouseover="showTip(event, 'fs57', 128)" class="i">trainCfg</span>
</code></pre></td>
</tr>
</table>
<p>This will produce output similar to</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
<span class="l">34: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">Initializing</span> <span class="i">model</span> <span class="i">parameters</span> <span class="k">for</span> <span class="i">training</span>
<span class="i">Training</span> <span class="k">with</span> <span class="i">Dataset</span> (<span class="n">54000</span> <span class="i">training</span>, <span class="n">6000</span> <span class="i">validation</span>, <span class="n">10000</span> <span class="i">test</span> <span class="i">Datasets</span><span class="o">.</span><span class="i">MnistTs</span>)
<span class="i">Using</span> <span class="i">learning</span> <span class="i">rate</span> <span class="n">0.001</span>
    <span class="n">10</span><span class="o">:</span>  <span class="i">trn</span><span class="o">=</span> <span class="n">0.5739</span>  <span class="k">val</span><span class="o">=</span> <span class="n">0.4652</span>  <span class="i">tst</span><span class="o">=</span> <span class="n">0.5173</span>
    <span class="n">20</span><span class="o">:</span>  <span class="i">trn</span><span class="o">=</span> <span class="n">0.3686</span>  <span class="k">val</span><span class="o">=</span> <span class="n">0.3210</span>  <span class="i">tst</span><span class="o">=</span> <span class="n">0.3583</span>
   <span class="o">..</span><span class="o">.</span>
   <span class="n">380</span><span class="o">:</span>  <span class="i">trn</span><span class="o">=</span> <span class="n">0.0155</span>  <span class="k">val</span><span class="o">=</span> <span class="n">0.1083</span>  <span class="i">tst</span><span class="o">=</span> <span class="n">0.1114</span>
   <span class="n">390</span><span class="o">:</span>  <span class="i">trn</span><span class="o">=</span> <span class="n">0.0146</span>  <span class="k">val</span><span class="o">=</span> <span class="n">0.1082</span>  <span class="i">tst</span><span class="o">=</span> <span class="n">0.1113</span>
   <span class="n">400</span><span class="o">:</span>  <span class="i">trn</span><span class="o">=</span> <span class="n">0.0137</span>  <span class="k">val</span><span class="o">=</span> <span class="n">0.1082</span>  <span class="i">tst</span><span class="o">=</span> <span class="n">0.1112</span>
   <span class="n">410</span><span class="o">:</span>  <span class="i">trn</span><span class="o">=</span> <span class="n">0.0129</span>  <span class="k">val</span><span class="o">=</span> <span class="n">0.1082</span>  <span class="i">tst</span><span class="o">=</span> <span class="n">0.1112</span>
   <span class="n">420</span><span class="o">:</span>  <span class="i">trn</span><span class="o">=</span> <span class="n">0.0121</span>  <span class="k">val</span><span class="o">=</span> <span class="n">0.1083</span>  <span class="i">tst</span><span class="o">=</span> <span class="n">0.1113</span>
   <span class="n">430</span><span class="o">:</span>  <span class="i">trn</span><span class="o">=</span> <span class="n">0.0114</span>  <span class="k">val</span><span class="o">=</span> <span class="n">0.1083</span>  <span class="i">tst</span><span class="o">=</span> <span class="n">0.1113</span>
   <span class="n">440</span><span class="o">:</span>  <span class="i">trn</span><span class="o">=</span> <span class="n">0.0108</span>  <span class="k">val</span><span class="o">=</span> <span class="n">0.1084</span>  <span class="i">tst</span><span class="o">=</span> <span class="n">0.1114</span>
   <span class="n">450</span><span class="o">:</span>  <span class="i">trn</span><span class="o">=</span> <span class="n">0.0102</span>  <span class="k">val</span><span class="o">=</span> <span class="n">0.1085</span>  <span class="i">tst</span><span class="o">=</span> <span class="n">0.1115</span>
   <span class="n">460</span><span class="o">:</span>  <span class="i">trn</span><span class="o">=</span> <span class="n">0.0096</span>  <span class="k">val</span><span class="o">=</span> <span class="n">0.1086</span>  <span class="i">tst</span><span class="o">=</span> <span class="n">0.1116</span>
   <span class="n">470</span><span class="o">:</span>  <span class="i">trn</span><span class="o">=</span> <span class="n">0.0091</span>  <span class="k">val</span><span class="o">=</span> <span class="n">0.1087</span>  <span class="i">tst</span><span class="o">=</span> <span class="n">0.1118</span>
   <span class="n">480</span><span class="o">:</span>  <span class="i">trn</span><span class="o">=</span> <span class="n">0.0086</span>  <span class="k">val</span><span class="o">=</span> <span class="n">0.1089</span>  <span class="i">tst</span><span class="o">=</span> <span class="n">0.1120</span>
   <span class="n">490</span><span class="o">:</span>  <span class="i">trn</span><span class="o">=</span> <span class="n">0.0081</span>  <span class="k">val</span><span class="o">=</span> <span class="n">0.1090</span>  <span class="i">tst</span><span class="o">=</span> <span class="n">0.1121</span>
   <span class="n">500</span><span class="o">:</span>  <span class="i">trn</span><span class="o">=</span> <span class="n">0.0077</span>  <span class="k">val</span><span class="o">=</span> <span class="n">0.1092</span>  <span class="i">tst</span><span class="o">=</span> <span class="n">0.1123</span>
   <span class="n">510</span><span class="o">:</span>  <span class="i">trn</span><span class="o">=</span> <span class="n">0.0073</span>  <span class="k">val</span><span class="o">=</span> <span class="n">0.1093</span>  <span class="i">tst</span><span class="o">=</span> <span class="n">0.1125</span>
<span class="i">Trained</span> <span class="k">for</span> <span class="n">110</span> <span class="i">iterations</span> <span class="i">without</span> <span class="i">improvement</span>
<span class="i">Using</span> <span class="i">learning</span> <span class="i">rate</span> <span class="n">0.0001</span>
   <span class="n">410</span><span class="o">:</span>  <span class="i">trn</span><span class="o">=</span> <span class="n">0.0135</span>  <span class="k">val</span><span class="o">=</span> <span class="n">0.1082</span>  <span class="i">tst</span><span class="o">=</span> <span class="n">0.1112</span>
   <span class="n">420</span><span class="o">:</span>  <span class="i">trn</span><span class="o">=</span> <span class="n">0.0134</span>  <span class="k">val</span><span class="o">=</span> <span class="n">0.1082</span>  <span class="i">tst</span><span class="o">=</span> <span class="n">0.1112</span>
   <span class="o">..</span><span class="o">.</span>
   <span class="n">510</span><span class="o">:</span>  <span class="i">trn</span><span class="o">=</span> <span class="n">0.0123</span>  <span class="k">val</span><span class="o">=</span> <span class="n">0.1083</span>  <span class="i">tst</span><span class="o">=</span> <span class="n">0.1113</span>
<span class="i">Trained</span> <span class="k">for</span> <span class="n">110</span> <span class="i">iterations</span> <span class="i">without</span> <span class="i">improvement</span>
<span class="i">Using</span> <span class="i">learning</span> <span class="i">rate</span> <span class="n">1e-05</span>
   <span class="n">410</span><span class="o">:</span>  <span class="i">trn</span><span class="o">=</span> <span class="n">0.0136</span>  <span class="k">val</span><span class="o">=</span> <span class="n">0.1082</span>  <span class="i">tst</span><span class="o">=</span> <span class="n">0.1112</span>
   <span class="n">420</span><span class="o">:</span>  <span class="i">trn</span><span class="o">=</span> <span class="n">0.0136</span>  <span class="k">val</span><span class="o">=</span> <span class="n">0.1082</span>  <span class="i">tst</span><span class="o">=</span> <span class="n">0.1112</span>
   <span class="o">..</span><span class="o">.</span>
   <span class="n">510</span><span class="o">:</span>  <span class="i">trn</span><span class="o">=</span> <span class="n">0.0134</span>  <span class="k">val</span><span class="o">=</span> <span class="n">0.1082</span>  <span class="i">tst</span><span class="o">=</span> <span class="n">0.1112</span>
<span class="i">Trained</span> <span class="k">for</span> <span class="n">110</span> <span class="i">iterations</span> <span class="i">without</span> <span class="i">improvement</span>
<span class="i">Training</span> <span class="i">completed</span> <span class="i">after</span> <span class="n">400</span> <span class="i">iterations</span> <span class="k">in</span> <span class="n">00</span><span class="o">:</span><span class="n">30</span><span class="o">:</span><span class="n">07.6179551</span> <span class="i">because</span> <span class="i">NoImprovement</span>
</code></pre></td>
</tr>
</table>
<p>While training is executed you can press the <code>q</code> key to stop training immediately and the <code>d</code> key to switch to the next learning rate specified in the configuration.</p>
<p>During training the parameters that produce the best validation loss are saved each time the losses are evaluated (as set by the <code>LossRecordInterval</code> field in the training configuration).
When the validation loss does not improve for the set number of iterations (field <code>Termination</code> in the training configuration), the best parameters are restored and the next learning rate (field <code>LearningRates</code>) from the configuration is used.
This explains why the iteration count resets by 100 steps, each time the loss stops improving.</p>
<p>The best validation lost is achieved around iteration 400, then the model starts to overfit.
Decreasing the learning rate does not help in this case, thus training is terminated after exhausting the list of learning rates.</p>
<h2><a name="Training-result-and-log" class="anchor" href="#Training-result-and-log">Training result and log</a></h2>
<p>The return value of <code>Train.train</code> is a record of type <code>TrainingResult</code> that contains the training results and the training log.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs64', 129)" onmouseover="showTip(event, 'fs64', 129)" class="f">printfn</span> <span class="s">&quot;Termination reason is </span><span class="pf">%A</span><span class="s"> after </span><span class="pf">%A</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs62', 130)" onmouseover="showTip(event, 'fs62', 130)" class="i">result</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs65', 131)" onmouseover="showTip(event, 'fs65', 131)" class="i">TerminationReason</span> <span onmouseout="hideTip(event, 'fs62', 132)" onmouseover="showTip(event, 'fs62', 132)" class="i">result</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs66', 133)" onmouseover="showTip(event, 'fs66', 133)" class="i">Duration</span>
<span onmouseout="hideTip(event, 'fs64', 134)" onmouseover="showTip(event, 'fs64', 134)" class="f">printfn</span> <span class="s">&quot;The best iteration is </span><span class="e">\n</span><span class="s"></span><span class="pf">%A</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs62', 135)" onmouseover="showTip(event, 'fs62', 135)" class="i">result</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs67', 136)" onmouseover="showTip(event, 'fs67', 136)" class="i">Best</span>
<span onmouseout="hideTip(event, 'fs64', 137)" onmouseover="showTip(event, 'fs64', 137)" class="f">printfn</span> <span class="s">&quot;The training log consists of </span><span class="pf">%d</span><span class="s"> entries.&quot;</span> (<span onmouseout="hideTip(event, 'fs68', 138)" onmouseover="showTip(event, 'fs68', 138)" class="t">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs69', 139)" onmouseover="showTip(event, 'fs69', 139)" class="f">length</span> <span onmouseout="hideTip(event, 'fs62', 140)" onmouseover="showTip(event, 'fs62', 140)" class="i">result</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs70', 141)" onmouseover="showTip(event, 'fs70', 141)" class="i">History</span>)
</code></pre></td>
</tr>
</table>
<p>This prints</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">Termination</span> <span class="i">reason</span> <span class="i">is</span> <span class="i">NoImprovement</span> <span class="i">after</span> <span class="n">00</span><span class="o">:</span><span class="n">29</span><span class="o">:</span><span class="n">28.1679299</span>
<span class="i">The</span> <span class="i">best</span> <span class="i">iteration</span> <span class="i">is</span> 
{<span class="i">Iter</span> <span class="o">=</span> <span class="n">400</span>;
 <span class="i">TrnLoss</span> <span class="o">=</span> <span class="n">0.01370835087</span>;
 <span class="i">ValLoss</span> <span class="o">=</span> <span class="n">0.1082176194</span>;
 <span class="i">TstLoss</span> <span class="o">=</span> <span class="n">0.1112449616</span>;
 <span class="i">LearningRate</span> <span class="o">=</span> <span class="n">0.001</span>;}
<span class="i">The</span> <span class="i">training</span> <span onmouseout="hideTip(event, 'fs71', 142)" onmouseover="showTip(event, 'fs71', 142)" class="i">log</span> <span class="i">consists</span> <span class="k">of</span> <span class="n">51</span> <span class="i">entries</span><span class="o">.</span>
</code></pre></td>
</tr>
</table>
<p>It is possible to save the training result as a JSON file by calling <code>result.Save</code>.
This is useful when you use software or scripts to gather and analyze the results of multiple experiments.</p>
<h2><a name="Checkpointing" class="anchor" href="#Checkpointing">Checkpointing</a></h2>
<p>Checkpoint allows to training process to be interrupted and resumed later.
To enable checkpoint support, set the <code>CheckpointDir</code> of the configuration record to some suitable directory.
This directory has to be unique for each process.</p>
<p>When checkpoint support is enabled, the training functions traps <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms682541(v=vs.85).aspx">the CTRL+C and CTRL+BREAK signals</a>.
When such a signal is received, the training state (including the model parameters) is stored in the specified directory and the process is terminated with exit code 10.
In this case, the training function does not return to the user code.</p>
<p>When the program is executed again and the training function is called, it checks for a valid checkpoint.
If one is found, it is loaded and training resumes where it was interrupted.</p>
<p>To discard an existing checkpoint (for example if training or models parameters were changed), set <code>DiscardCheckpoint</code> to true.
This will delete any existing checkpoints from disk and restart training from the beginning.</p>
<h1><a name="Summary" class="anchor" href="#Summary">Summary</a></h1>
<p>With the generic training function you can train any model that has a loss expression.
The main effort is to write a small wrapper function that maps a training sample to a variable environment.
Various termination criteria, common in machine learning, are implemented.</p>

<div class="tip" id="fs1">namespace SymTensor</div>
<div class="tip" id="fs2">namespace SymTensor.Compiler</div>
<div class="tip" id="fs3">namespace SymTensor.Compiler.Cuda</div>
<div class="tip" id="fs4">namespace Models</div>
<div class="tip" id="fs5">namespace Datasets</div>
<div class="tip" id="fs6">namespace Optimizers</div>
<div class="tip" id="fs7">val mnist : TrnValTst&lt;MnistT&gt;<br /><br />Full name: Training.mnist</div>
<div class="tip" id="fs8">module Mnist<br /><br />from Datasets</div>
<div class="tip" id="fs9">val load : directory:string -&gt; valRatio:float -&gt; TrnValTst&lt;MnistT&gt;<br /><br />Full name: Datasets.Mnist.load</div>
<div class="tip" id="fs10">type TrnValTst&lt;&#39;S&gt; =<br />&#160;&#160;{Trn: Dataset&lt;&#39;S&gt;;<br />&#160;&#160;&#160;Val: Dataset&lt;&#39;S&gt;;<br />&#160;&#160;&#160;Tst: Dataset&lt;&#39;S&gt;;}<br />&#160;&#160;member Save : filename:string -&gt; unit<br />&#160;&#160;member ToCuda : unit -&gt; TrnValTst&lt;&#39;S&gt;<br />&#160;&#160;member ToHost : unit -&gt; TrnValTst&lt;&#39;S&gt;<br />&#160;&#160;member private Pretty : string<br />&#160;&#160;static member Load : filename:string -&gt; TrnValTst&lt;&#39;S&gt;<br />&#160;&#160;static member Of : dataset:Dataset&lt;&#39;S&gt; * ?trnRatio:float * ?valRatio:float * ?tstRatio:float -&gt; TrnValTst&lt;&#39;S&gt;<br />&#160;&#160;static member ToCuda : this:TrnValTst&lt;&#39;S&gt; -&gt; TrnValTst&lt;&#39;S&gt;<br />&#160;&#160;static member ToHost : this:TrnValTst&lt;&#39;S&gt; -&gt; TrnValTst&lt;&#39;S&gt;<br /><br />Full name: Datasets.TrnValTst&lt;_&gt;</div>
<div class="tip" id="fs11">static member TrnValTst.ToCuda : this:TrnValTst&lt;&#39;S&gt; -&gt; TrnValTst&lt;&#39;S&gt;</div>
<div class="tip" id="fs12">val mb : ModelBuilder&lt;single&gt;<br /><br />Full name: Training.mb</div>
<div class="tip" id="fs13">Multiple items<br />type ModelBuilder&lt;&#39;T (requires equality)&gt; =<br />&#160;&#160;new : context:string -&gt; ModelBuilder&lt;&#39;T&gt;<br />&#160;&#160;new : context:string * isSubModule:bool -&gt; ModelBuilder&lt;&#39;T&gt;<br />&#160;&#160;member Fix : size:int -&gt; SizeSpecT<br />&#160;&#160;member Instantiate : device:IDevice * ?canDelay:bool -&gt; ModelInstance&lt;&#39;T&gt;<br />&#160;&#160;member Module : name:string -&gt; ModelBuilder&lt;&#39;T&gt;<br />&#160;&#160;member Param : name:string * shape:ShapeSpecT * ?initializer:Initializer&lt;&#39;T&gt; -&gt; ExprT&lt;&#39;T&gt; ref<br />&#160;&#160;member SetLoc : var:ExprT&lt;&#39;a1&gt; -&gt; loc:ArrayLocT -&gt; unit<br />&#160;&#160;member SetSize : size:SizeSpecT -&gt; value:int -&gt; unit<br />&#160;&#160;member Size : name:string -&gt; SizeSpecT<br />&#160;&#160;member UseTmplVal : var:ExprT&lt;&#39;a1&gt; -&gt; value:ArrayNDT&lt;&#39;a1&gt; -&gt; unit<br />&#160;&#160;...<br /><br />Full name: SymTensor.ModelContextTypes.ModelBuilder&lt;_&gt;<br /><br />--------------------<br />new : context:string -&gt; ModelBuilder&lt;&#39;T&gt;<br />new : context:string * isSubModule:bool -&gt; ModelBuilder&lt;&#39;T&gt;</div>
<div class="tip" id="fs14">Multiple items<br />val single : value:&#39;T -&gt; single (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.single<br /><br />--------------------<br />type single = System.Single<br /><br />Full name: Microsoft.FSharp.Core.single</div>
<div class="tip" id="fs15">val nBatch : SizeSpecT<br /><br />Full name: Training.nBatch</div>
<div class="tip" id="fs16">member ModelBuilder.Size : name:string -&gt; SizeSpecT</div>
<div class="tip" id="fs17">val nInput : SizeSpecT<br /><br />Full name: Training.nInput</div>
<div class="tip" id="fs18">val nClass : SizeSpecT<br /><br />Full name: Training.nClass</div>
<div class="tip" id="fs19">val nHidden : SizeSpecT<br /><br />Full name: Training.nHidden</div>
<div class="tip" id="fs20">val mlp : MLP.Pars&lt;single&gt;<br /><br />Full name: Training.mlp</div>
<div class="tip" id="fs21">module MLP<br /><br />from Models</div>
<div class="tip" id="fs22">val pars : mb:ModelBuilder&lt;&#39;a&gt; -&gt; hp:MLP.HyperPars -&gt; MLP.Pars&lt;&#39;a&gt; (requires equality)<br /><br />Full name: Models.MLP.pars</div>
<div class="tip" id="fs23">member ModelBuilder.Module : name:string -&gt; ModelBuilder&lt;&#39;T&gt;</div>
<div class="tip" id="fs24">module NeuralLayer<br /><br />from Models</div>
<div class="tip" id="fs25">union case NeuralLayer.TransferFuncs.Tanh: NeuralLayer.TransferFuncs</div>
<div class="tip" id="fs26">union case NeuralLayer.TransferFuncs.SoftMax: NeuralLayer.TransferFuncs</div>
<div class="tip" id="fs27">module LossLayer<br /><br />from Models</div>
<div class="tip" id="fs28">union case LossLayer.Measures.CrossEntropy: LossLayer.Measures</div>
<div class="tip" id="fs29">val input : ExprT&lt;single&gt;<br /><br />Full name: Training.input</div>
<div class="tip" id="fs30">type ExprT&lt;&#39;T&gt; = Expr.ExprT&lt;&#39;T&gt;<br /><br />Full name: SymTensor.ExprTypes2.ExprT&lt;_&gt;</div>
<div class="tip" id="fs31">member ModelBuilder.Var : name:string -&gt; shape:ShapeSpecT -&gt; Expr.ExprT&lt;&#39;a&gt;</div>
<div class="tip" id="fs32">val target : ExprT&lt;single&gt;<br /><br />Full name: Training.target</div>
<div class="tip" id="fs33">member ModelBuilder.SetSize : size:SizeSpecT -&gt; value:int -&gt; unit</div>
<div class="tip" id="fs34">TrnValTst.Trn: Dataset&lt;MnistT&gt;</div>
<div class="tip" id="fs35">val mi : ModelInstance&lt;single&gt;<br /><br />Full name: Training.mi</div>
<div class="tip" id="fs36">member ModelBuilder.Instantiate : device:IDevice * ?canDelay:bool -&gt; ModelInstance&lt;&#39;T&gt;</div>
<div class="tip" id="fs37">val DevCuda : IDevice<br /><br />Full name: SymTensor.Compiler.Cuda.CudaEvalTypes.DevCuda</div>
<div class="tip" id="fs38">val loss : Expr.ExprT&lt;single&gt;<br /><br />Full name: Training.loss</div>
<div class="tip" id="fs39">val loss : pars:MLP.Pars&lt;&#39;a&gt; -&gt; input:Expr.ExprT&lt;&#39;a&gt; -&gt; target:ExprT&lt;&#39;a&gt; -&gt; Expr.ExprT&lt;&#39;a&gt;<br /><br />Full name: Models.MLP.loss</div>
<div class="tip" id="fs40">property Expr.ExprT.T: Expr.ExprT&lt;single&gt;</div>
<div class="tip" id="fs41">val opt : Adam&lt;single&gt;<br /><br />Full name: Training.opt</div>
<div class="tip" id="fs42">Multiple items<br />module Adam<br /><br />from Optimizers<br /><br />--------------------<br />type Adam&lt;&#39;T (requires equality)&gt; =<br />&#160;&#160;interface IOptimizer&lt;&#39;T,Cfg&lt;&#39;T&gt;,State&lt;&#39;T&gt;&gt;<br />&#160;&#160;new : loss:ExprT&lt;&#39;T&gt; * pars:ExprT&lt;&#39;T&gt; * dev:IDevice -&gt; Adam&lt;&#39;T&gt;<br />&#160;&#160;member InitialState : cfg:Cfg&lt;&#39;T&gt; -&gt; parVals:IArrayNDT -&gt; State&lt;&#39;T&gt;<br />&#160;&#160;member PublishLoc : mb:ModelInstance&lt;&#39;a1&gt; -&gt; unit (requires equality)<br />&#160;&#160;member Use : f:(VarEnvT -&gt; &#39;a1) -&gt; (VarEnvT -&gt; Cfg&lt;&#39;T&gt; -&gt; State&lt;&#39;T&gt; -&gt; &#39;a1)<br />&#160;&#160;member DefaultCfg : Cfg&lt;&#39;T&gt;<br />&#160;&#160;member Minimize : ExprT&lt;&#39;T&gt;<br /><br />Full name: Optimizers.AdamTypes.Adam&lt;_&gt;<br /><br />--------------------<br />new : loss:ExprT&lt;&#39;T&gt; * pars:ExprT&lt;&#39;T&gt; * dev:IDevice -&gt; Adam&lt;&#39;T&gt;</div>
<div class="tip" id="fs43">property ModelInstance.ParameterVector: ExprT&lt;single&gt;</div>
<div class="tip" id="fs44">val optCfg : Adam.Cfg&lt;single&gt;<br /><br />Full name: Training.optCfg</div>
<div class="tip" id="fs45">property Adam.DefaultCfg: Adam.Cfg&lt;single&gt;</div>
<div class="tip" id="fs46">val smplVarEnv : smpl:MnistT -&gt; VarEnvT<br /><br />Full name: Training.smplVarEnv</div>
<div class="tip" id="fs47">val smpl : MnistT</div>
<div class="tip" id="fs48">type MnistT =<br />&#160;&#160;{Img: ArrayNDT&lt;single&gt;;<br />&#160;&#160;&#160;Lbl: ArrayNDT&lt;single&gt;;}<br /><br />Full name: Datasets.MnistT</div>
<div class="tip" id="fs49">module VarEnv<br /><br />from SymTensor</div>
<div class="tip" id="fs50">val empty : VarEnvT<br /><br />Full name: SymTensor.VarEnv.empty</div>
<div class="tip" id="fs51">val add : var:Expr.ExprT&lt;&#39;T&gt; -&gt; value:ArrayNDNS.ArrayNDTypes2.ArrayNDT&lt;&#39;T&gt; -&gt; varEnv:VarEnvT -&gt; VarEnvT<br /><br />Full name: SymTensor.VarEnv.add</div>
<div class="tip" id="fs52">MnistT.Img: ArrayNDNS.ArrayNDTypes2.ArrayNDT&lt;single&gt;</div>
<div class="tip" id="fs53">MnistT.Lbl: ArrayNDNS.ArrayNDTypes2.ArrayNDT&lt;single&gt;</div>
<div class="tip" id="fs54">val trainable : Train.ITrainable&lt;MnistT,single&gt;<br /><br />Full name: Training.trainable</div>
<div class="tip" id="fs55">module Train<br /><br />from Models</div>
<div class="tip" id="fs56">val trainableFromLossExpr : modelInstance:ModelInstance&lt;&#39;T&gt; -&gt; loss:ExprT&lt;&#39;T&gt; -&gt; varEnvBuilder:(&#39;Smpl -&gt; VarEnvT) -&gt; optimizer:IOptimizer&lt;&#39;T,&#39;OptCfg,&#39;OptState&gt; -&gt; optCfg:&#39;OptCfg -&gt; Train.ITrainable&lt;&#39;Smpl,&#39;T&gt; (requires equality)<br /><br />Full name: Models.Train.trainableFromLossExpr</div>
<div class="tip" id="fs57">val trainCfg : Train.Cfg<br /><br />Full name: Training.trainCfg</div>
<div class="tip" id="fs58">type Cfg =<br />&#160;&#160;{Seed: int;<br />&#160;&#160;&#160;BatchSize: int;<br />&#160;&#160;&#160;LossRecordInterval: int;<br />&#160;&#160;&#160;Termination: TerminationCriterium;<br />&#160;&#160;&#160;MinImprovement: float;<br />&#160;&#160;&#160;TargetLoss: float option;<br />&#160;&#160;&#160;MinIters: int option;<br />&#160;&#160;&#160;MaxIters: int option;<br />&#160;&#160;&#160;LearningRates: float list;<br />&#160;&#160;&#160;CheckpointDir: string option;<br />&#160;&#160;&#160;...}<br /><br />Full name: Models.Train.Cfg</div>
<div class="tip" id="fs59">union case Train.TerminationCriterium.ItersWithoutImprovement: int -&gt; Train.TerminationCriterium</div>
<div class="tip" id="fs60">union case Option.None: Option&lt;&#39;T&gt;</div>
<div class="tip" id="fs61">union case Option.Some: Value: &#39;T -&gt; Option&lt;&#39;T&gt;</div>
<div class="tip" id="fs62">val result : Train.TrainingResult<br /><br />Full name: Training.result</div>
<div class="tip" id="fs63">val train : trainable:Train.ITrainable&lt;&#39;Smpl,&#39;T&gt; -&gt; dataset:TrnValTst&lt;&#39;Smpl&gt; -&gt; cfg:Train.Cfg -&gt; Train.TrainingResult<br /><br />Full name: Models.Train.train</div>
<div class="tip" id="fs64">val printfn : format:Printf.TextWriterFormat&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.printfn</div>
<div class="tip" id="fs65">Train.TrainingResult.TerminationReason: Train.Faith</div>
<div class="tip" id="fs66">Train.TrainingResult.Duration: System.TimeSpan</div>
<div class="tip" id="fs67">Train.TrainingResult.Best: TrainingLog.Entry</div>
<div class="tip" id="fs68">Multiple items<br />module List<br /><br />from Microsoft.FSharp.Collections<br /><br />--------------------<br />type List&lt;&#39;T&gt; =<br />&#160;&#160;| ( [] )<br />&#160;&#160;| ( :: ) of Head: &#39;T * Tail: &#39;T list<br />&#160;&#160;interface IEnumerable<br />&#160;&#160;interface IEnumerable&lt;&#39;T&gt;<br />&#160;&#160;member GetSlice : startIndex:int option * endIndex:int option -&gt; &#39;T list<br />&#160;&#160;member Head : &#39;T<br />&#160;&#160;member IsEmpty : bool<br />&#160;&#160;member Item : index:int -&gt; &#39;T with get<br />&#160;&#160;member Length : int<br />&#160;&#160;member Tail : &#39;T list<br />&#160;&#160;static member Cons : head:&#39;T * tail:&#39;T list -&gt; &#39;T list<br />&#160;&#160;static member Empty : &#39;T list<br /><br />Full name: Microsoft.FSharp.Collections.List&lt;_&gt;</div>
<div class="tip" id="fs69">val length : list:&#39;T list -&gt; int<br /><br />Full name: Microsoft.FSharp.Collections.List.length</div>
<div class="tip" id="fs70">Train.TrainingResult.History: TrainingLog.Entry list</div>
<div class="tip" id="fs71">val log : value:&#39;T -&gt; &#39;T (requires member Log)<br /><br />Full name: Microsoft.FSharp.Core.Operators.log</div>

        </div>
        <div class="span3">
          <!-- <img src="file://C:\local\surban\dev\Deep\DeepNet\docs\tools\../output/img/logo.png" alt="Deep.Net logo" style="width:150px;margin:10px" /> -->  
          <ul class="nav nav-list" id="menu" style="margin-top: 20px;">
            <li class="nav-header">Deep.Net</li>
            <li><a href="file://C:\local\surban\dev\Deep\DeepNet\docs\tools\../output/index.html">Home page</a></li>
            <li class="divider"></li>
            <li><a href="http://nuget.org/packages/DeepNet">Get Library via NuGet</a></li>
            <li><a href="http://github.com/DeepMLNet/DeepNet">Source Code on GitHub</a></li>
            <li><a href="file://C:\local\surban\dev\Deep\DeepNet\docs\tools\../output/release-notes.html">Release Notes</a></li>
            
            <li class="nav-header">Getting started</li>
            <li><a href="file://C:\local\surban\dev\Deep\DeepNet\docs\tools\../output/tensor.html">Working with Tensors</a></li>
            <li><a href="file://C:\local\surban\dev\Deep\DeepNet\docs\tools\../output/mnist.html">Model Definition</a></li>
            <li><a href="file://C:\local\surban\dev\Deep\DeepNet\docs\tools\../output/blocks.html">Model Components</a></li>
            <li><a href="file://C:\local\surban\dev\Deep\DeepNet\docs\tools\../output/diff.html">Automatic Differentiation</a></li>
            <li><a href="file://C:\local\surban\dev\Deep\DeepNet\docs\tools\../output/dataset.html">Dataset Handling</a></li>
            <li><a href="file://C:\local\surban\dev\Deep\DeepNet\docs\tools\../output/training.html">Generic Training</a></li>

            <li class="nav-header">Documentation</li>
            <li><a href="file://C:\local\surban\dev\Deep\DeepNet\docs\tools\../output/reference/index.html">API Reference</a></li>
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/DeepMLNet/DeepNet"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"/></a>
  </body>
  </html>
