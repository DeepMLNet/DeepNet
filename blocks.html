<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Model Components
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="Deep.Net machine learning framework"/>
    <meta name="author" content="Deep.Net developers"/>

    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet"/>

    <link type="text/css" rel="stylesheet" href="http://www.deepml.net/content/style.css" />
    <script type="text/javascript" src="http://www.deepml.net/content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <![endif]-->

    <script type="text/javascript" async
              src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://github.com/DeepMLNet/DeepNet">github page</a></li>
        </ul>
        <h3 class="muted"><a href="http://www.deepml.net/index.html">Deep.Net</a></h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<h1><a name="Model-Components" class="anchor" href="#Model-Components">Model Components</a></h1>
<p>As you start building more complex machine learning models, it becomes beneficial to build the model from small, reusable components.
For example it makes sense to define a generic <a href="https://en.wikipedia.org/wiki/Multilayer_perceptron">multilayer perceptron</a> component and use it in multiple models.
In Deep.Net, a model component can contain other model components; for example an autoencoder component could be built using two multi-layer perceptron components.</p>
<p>In this document we will describe how to build a simple layer of neurons and how to instantiate it in your model.</p>
<h2><a name="Defining-a-model-component" class="anchor" href="#Defining-a-model-component">Defining a model component</a></h2>
<p>A model component corresponds to an F# module that contains conventionally named types and functions.
We will call our example component <code>Perceptron</code>.</p>
<p>We will build a component for a single layer of neurons.
Our neural layer will compute the function <span class="math">\(f(\mathbf{x}) = \sigma ( W \mathbf{x} + \mathbf{b} )\)</span> where <span class="math">\(\sigma\)</span> can be either <span class="math">\(\mathrm{tanh}\)</span> or the identity function <span class="math">\(\mathrm{id}\)</span>. <span class="math">\(W\)</span> is the weight matrix and <span class="math">\(\mathbf{b}\)</span> is the bias vector.</p>
<p>Consequently our component has two parameters (a parameter is a quantity that changes during model training): <span class="math">\(W\)</span> and <span class="math">\(\mathbf{b}\)</span>.
These two parameters give rise to two integer hyper-parameters (a hyper-parameter is fixed a model definition and does not change during training): the number of inputs <code>NInput</code> (number of columns in <span class="math">\(W\)</span>) and the number of outputs <code>NOutput</code> (number of rows in <span class="math">\(W\)</span>).
Furthermore we have the transfer function as a third, discrete hyper-parameter <code>TransferFunc</code> that can either be <code>Tanh</code> or <code>Identity</code>.
Let us define record types for the parameters and hyper-parameters.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">open</span> <span class="i">ArrayNDNS</span>; <span class="k">open</span> <span class="i">SymTensor</span>

<span class="k">module</span> <span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="t">Perceptron</span> <span class="o">=</span> 

    <span class="k">type</span> <span onmouseout="hideTip(event, 'fs2', 2)" onmouseover="showTip(event, 'fs2', 2)" class="t">TransferFuncs</span> <span class="o">=</span>
        | <span onmouseout="hideTip(event, 'fs3', 3)" onmouseover="showTip(event, 'fs3', 3)" class="p">Tanh</span>
        | <span onmouseout="hideTip(event, 'fs4', 4)" onmouseover="showTip(event, 'fs4', 4)" class="p">Identity</span>

    <span class="k">type</span> <span onmouseout="hideTip(event, 'fs5', 5)" onmouseover="showTip(event, 'fs5', 5)" class="t">HyperPars</span> <span class="o">=</span> {
        <span onmouseout="hideTip(event, 'fs6', 6)" onmouseover="showTip(event, 'fs6', 6)" class="i">NInput</span><span class="o">:</span>         <span class="i">SizeSpecT</span>
        <span onmouseout="hideTip(event, 'fs7', 7)" onmouseover="showTip(event, 'fs7', 7)" class="i">NOutput</span><span class="o">:</span>        <span class="i">SizeSpecT</span>
        <span onmouseout="hideTip(event, 'fs8', 8)" onmouseover="showTip(event, 'fs8', 8)" class="i">TransferFunc</span><span class="o">:</span>   <span onmouseout="hideTip(event, 'fs2', 9)" onmouseover="showTip(event, 'fs2', 9)" class="t">TransferFuncs</span>
    }

    <span class="k">type</span> <span onmouseout="hideTip(event, 'fs9', 10)" onmouseover="showTip(event, 'fs9', 10)" class="t">Pars</span> <span class="o">=</span> {
        <span onmouseout="hideTip(event, 'fs10', 11)" onmouseover="showTip(event, 'fs10', 11)" class="i">Weights</span><span class="o">:</span>        <span class="i">ExprT</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs11', 12)" onmouseover="showTip(event, 'fs11', 12)" class="i">single</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs12', 13)" onmouseover="showTip(event, 'fs12', 13)" class="t">ref</span>
        <span onmouseout="hideTip(event, 'fs13', 14)" onmouseover="showTip(event, 'fs13', 14)" class="i">Bias</span><span class="o">:</span>           <span class="i">ExprT</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs11', 15)" onmouseover="showTip(event, 'fs11', 15)" class="i">single</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs12', 16)" onmouseover="showTip(event, 'fs12', 16)" class="t">ref</span>
        <span onmouseout="hideTip(event, 'fs14', 17)" onmouseover="showTip(event, 'fs14', 17)" class="i">HyperPars</span><span class="o">:</span>      <span onmouseout="hideTip(event, 'fs14', 18)" onmouseover="showTip(event, 'fs14', 18)" class="t">HyperPars</span>
    }
</code></pre></td>
</tr>
</table>
<p>We see that, by convention, the record type for the hyper-parameters is named <code>HyperPars</code>.
The fields <code>NInput</code> and <code>NOutput</code> have been defined as type <code>SizeSpecT</code>.
This is the type used by Deep.Net to represent an integral size, either symbolic or numeric.</p>
<p>Also by convention, the record type that stores the model parameters is named <code>Pars</code>.
The weights and bias have been defined as type <code>ExprT&lt;single&gt; ref</code>.</p>
<p><code>SymTensor.ExprT&lt;'T&gt;</code> is the type of an symbolic tensor expression of data type <code>'T</code>.
For example <code>'T</code> can be <code>float</code> for a tensor containing double precision floating point numbers or, as in this case, <code>single</code> for single precision floats.
The reader might wonder, why we use the generic expression type instead of the <code>VarSpecT</code> type that represents a symbolic variable in Deep.Net.
After all, the model's parameters are variables, are they not?</p>
<p>While in most cases, a model parameter will be a tensor variable, it makes sense to let the user pass an arbitrary expression for the model parameter.
Consider, for example, an auto-encoder with tied input/output weights (this means that the weights of the output layer are given by the transposition of the weights of the input layer).
The user can construct such an auto-encoder using two of our perceptron components.
He just needs to set <code>pOut.Weights &lt;- pIn.Weights.T</code>, where <code>pOut</code> represents the parameters of the output layer and <code>pIn</code> represents the parameters of the input layer, to tie the input and output weights together.
But this would not be possible if <code>Pars.Weights</code> was of type <code>VarSpecT</code> since <code>pIn.Weights.T</code> is an expression due to the use of the transposition operation.</p>
<p>Furthermore we observe that <code>Weights</code> and <code>Bias</code> have been declared as reference cells.
We will see the reason for that in a few lines further below.</p>
<p>Let us now define the functions of ours component's module.</p>
<p>We define a function <code>pars</code> that, by convention, returns an instance of the parameter record.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp">    <span class="k">let</span> <span class="k">internal</span> <span onmouseout="hideTip(event, 'fs15', 19)" onmouseover="showTip(event, 'fs15', 19)" class="f">initBias</span> (<span onmouseout="hideTip(event, 'fs16', 20)" onmouseover="showTip(event, 'fs16', 20)" class="i">seed</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs17', 21)" onmouseover="showTip(event, 'fs17', 21)" class="t">int</span>) (<span onmouseout="hideTip(event, 'fs18', 22)" onmouseover="showTip(event, 'fs18', 22)" class="i">shp</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs17', 23)" onmouseover="showTip(event, 'fs17', 23)" class="t">int</span> <span onmouseout="hideTip(event, 'fs19', 24)" onmouseover="showTip(event, 'fs19', 24)" class="t">list</span>) <span class="o">:</span> <span class="i">ArrayNDHostT</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs11', 25)" onmouseover="showTip(event, 'fs11', 25)" class="i">single</span><span class="o">&gt;</span> <span class="o">=</span>
        <span class="i">ArrayNDHost</span><span class="o">.</span><span class="i">zeros</span> <span onmouseout="hideTip(event, 'fs18', 26)" onmouseover="showTip(event, 'fs18', 26)" class="i">shp</span>

    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs20', 27)" onmouseover="showTip(event, 'fs20', 27)" class="f">pars</span> (<span onmouseout="hideTip(event, 'fs21', 28)" onmouseover="showTip(event, 'fs21', 28)" class="i">mb</span><span class="o">:</span> <span class="i">ModelBuilder</span><span class="o">&lt;</span>_<span class="o">&gt;</span>) (<span onmouseout="hideTip(event, 'fs22', 29)" onmouseover="showTip(event, 'fs22', 29)" class="i">hp</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs5', 30)" onmouseover="showTip(event, 'fs5', 30)" class="t">HyperPars</span>) <span class="o">=</span> {
        <span class="i">Weights</span>   <span class="o">=</span> <span onmouseout="hideTip(event, 'fs21', 31)" onmouseover="showTip(event, 'fs21', 31)" class="i">mb</span><span class="o">.</span><span class="i">Param</span> (<span class="s">&quot;Weights&quot;</span>, [<span onmouseout="hideTip(event, 'fs22', 32)" onmouseover="showTip(event, 'fs22', 32)" class="i">hp</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs7', 33)" onmouseover="showTip(event, 'fs7', 33)" class="i">NOutput</span>; <span onmouseout="hideTip(event, 'fs22', 34)" onmouseover="showTip(event, 'fs22', 34)" class="i">hp</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs6', 35)" onmouseover="showTip(event, 'fs6', 35)" class="i">NInput</span>])
        <span class="i">Bias</span>      <span class="o">=</span> <span onmouseout="hideTip(event, 'fs21', 36)" onmouseover="showTip(event, 'fs21', 36)" class="i">mb</span><span class="o">.</span><span class="i">Param</span> (<span class="s">&quot;Bias&quot;</span>,    [<span onmouseout="hideTip(event, 'fs22', 37)" onmouseover="showTip(event, 'fs22', 37)" class="i">hp</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs7', 38)" onmouseover="showTip(event, 'fs7', 38)" class="i">NOutput</span>], <span onmouseout="hideTip(event, 'fs15', 39)" onmouseover="showTip(event, 'fs15', 39)" class="i">initBias</span>)
        <span onmouseout="hideTip(event, 'fs5', 40)" onmouseover="showTip(event, 'fs5', 40)" class="i">HyperPars</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs22', 41)" onmouseover="showTip(event, 'fs22', 41)" class="i">hp</span>
    }
</code></pre></td>
</tr>
</table>
<p>The function <code>pars</code> takes two arguments: a model builder and the hyper-parameters of the component.
It construct a parameter record and populates the weights and bias with parameter tensors obtain from the model builder by calling <code>mb.Param</code> with the appropriate shapes from the hyper-parameters.</p>
<p>For the bias we also specify the custom initialization function <code>initBias</code>.
A custom initialization function takes two arguments: a random seed and a list of integers representing the shape of the instantiated parameter tensor.
It should return the initialization value of appropriate shape for the parameter.
Here, we initialize the bias with zero and thus return a zero tensor of the requested shape.
If no custom initializer is specified, the parameter is initialized using random numbers from a uniform distribution with support <span class="math">\(\[ TODO \]\)</span>.</p>
<p>We also store a reference to the hyper-parameters in our parameter record to save ourselves the trouble of passing the hyper-parameter record to functions that require both the parameter record and the hyper-parameter record.</p>
<p>Now, we can define the function that returns the expression for the output of the perceptron component.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp">    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs23', 42)" onmouseover="showTip(event, 'fs23', 42)" class="f">pred</span> <span onmouseout="hideTip(event, 'fs24', 43)" onmouseover="showTip(event, 'fs24', 43)" class="i">pars</span> <span onmouseout="hideTip(event, 'fs25', 44)" onmouseover="showTip(event, 'fs25', 44)" class="i">input</span> <span class="o">=</span>
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs26', 45)" onmouseover="showTip(event, 'fs26', 45)" class="i">activation</span> <span class="o">=</span> <span class="o">!</span><span onmouseout="hideTip(event, 'fs24', 46)" onmouseover="showTip(event, 'fs24', 46)" class="i">pars</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs10', 47)" onmouseover="showTip(event, 'fs10', 47)" class="i">Weights</span> <span class="o">.</span><span class="o">*</span> <span onmouseout="hideTip(event, 'fs25', 48)" onmouseover="showTip(event, 'fs25', 48)" class="i">input</span> <span class="o">+</span> <span class="o">!</span><span onmouseout="hideTip(event, 'fs24', 49)" onmouseover="showTip(event, 'fs24', 49)" class="i">pars</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs13', 50)" onmouseover="showTip(event, 'fs13', 50)" class="i">Bias</span>
        <span class="k">match</span> <span onmouseout="hideTip(event, 'fs24', 51)" onmouseover="showTip(event, 'fs24', 51)" class="i">pars</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs27', 52)" onmouseover="showTip(event, 'fs27', 52)" class="i">HyperPars</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 53)" onmouseover="showTip(event, 'fs8', 53)" class="i">TransferFunc</span> <span class="k">with</span>
        | <span onmouseout="hideTip(event, 'fs3', 54)" onmouseover="showTip(event, 'fs3', 54)" class="p">Tanh</span>     <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs28', 55)" onmouseover="showTip(event, 'fs28', 55)" class="f">tanh</span> <span onmouseout="hideTip(event, 'fs26', 56)" onmouseover="showTip(event, 'fs26', 56)" class="i">activation</span>
        | <span onmouseout="hideTip(event, 'fs4', 57)" onmouseover="showTip(event, 'fs4', 57)" class="p">Identity</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs26', 58)" onmouseover="showTip(event, 'fs26', 58)" class="i">activation</span>
</code></pre></td>
</tr>
</table>
<p>The function computes the activation using the formula specified above and then applies the transfer function specified in the hyper-parameters.
The <code>!</code> operator is used to dereference the reference cells in the parameter record.</p>
<p>This concludes the definition of our model component.</p>
<h2><a name="Using-a-model-component" class="anchor" href="#Using-a-model-component">Using a model component</a></h2>

<div class="tip" id="fs1">module Perceptron<br /><br />from Blocks</div>
<div class="tip" id="fs2">type TransferFuncs =<br />&#160;&#160;| Tanh<br />&#160;&#160;| Identity<br /><br />Full name: Blocks.Perceptron.TransferFuncs</div>
<div class="tip" id="fs3">union case TransferFuncs.Tanh: TransferFuncs</div>
<div class="tip" id="fs4">union case TransferFuncs.Identity: TransferFuncs</div>
<div class="tip" id="fs5">type HyperPars =<br />&#160;&#160;{NInput: obj;<br />&#160;&#160;&#160;NOutput: obj;<br />&#160;&#160;&#160;TransferFunc: TransferFuncs;}<br /><br />Full name: Blocks.Perceptron.HyperPars</div>
<div class="tip" id="fs6">HyperPars.NInput: obj</div>
<div class="tip" id="fs7">HyperPars.NOutput: obj</div>
<div class="tip" id="fs8">HyperPars.TransferFunc: TransferFuncs</div>
<div class="tip" id="fs9">type Pars =<br />&#160;&#160;{Weights: obj;<br />&#160;&#160;&#160;Bias: obj;<br />&#160;&#160;&#160;HyperPars: HyperPars;}<br /><br />Full name: Blocks.Perceptron.Pars</div>
<div class="tip" id="fs10">Pars.Weights: obj</div>
<div class="tip" id="fs11">Multiple items<br />val single : value:&#39;T -&gt; single (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.single<br /><br />--------------------<br />type single = System.Single<br /><br />Full name: Microsoft.FSharp.Core.single</div>
<div class="tip" id="fs12">Multiple items<br />val ref : value:&#39;T -&gt; &#39;T ref<br /><br />Full name: Microsoft.FSharp.Core.Operators.ref<br /><br />--------------------<br />type &#39;T ref = Ref&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Core.ref&lt;_&gt;</div>
<div class="tip" id="fs13">Pars.Bias: obj</div>
<div class="tip" id="fs14">Multiple items<br />Pars.HyperPars: HyperPars<br /><br />--------------------<br />type HyperPars =<br />&#160;&#160;{NInput: obj;<br />&#160;&#160;&#160;NOutput: obj;<br />&#160;&#160;&#160;TransferFunc: TransferFuncs;}<br /><br />Full name: Blocks.Perceptron.HyperPars</div>
<div class="tip" id="fs15">val internal initBias : seed:int -&gt; shp:int list -&gt; &#39;a<br /><br />Full name: Blocks.Perceptron.initBias</div>
<div class="tip" id="fs16">val seed : int</div>
<div class="tip" id="fs17">Multiple items<br />val int : value:&#39;T -&gt; int (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.Operators.int<br /><br />--------------------<br />type int = int32<br /><br />Full name: Microsoft.FSharp.Core.int<br /><br />--------------------<br />type int&lt;&#39;Measure&gt; = int<br /><br />Full name: Microsoft.FSharp.Core.int&lt;_&gt;</div>
<div class="tip" id="fs18">val shp : int list</div>
<div class="tip" id="fs19">type &#39;T list = List&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.list&lt;_&gt;</div>
<div class="tip" id="fs20">val pars : mb:&#39;a -&gt; hp:HyperPars -&gt; Pars<br /><br />Full name: Blocks.Perceptron.pars</div>
<div class="tip" id="fs21">val mb : &#39;a</div>
<div class="tip" id="fs22">val hp : HyperPars</div>
<div class="tip" id="fs23">val pred : pars:Pars -&gt; input:obj -&gt; float<br /><br />Full name: Blocks.Perceptron.pred</div>
<div class="tip" id="fs24">val pars : Pars</div>
<div class="tip" id="fs25">val input : obj</div>
<div class="tip" id="fs26">val activation : float</div>
<div class="tip" id="fs27">Pars.HyperPars: HyperPars</div>
<div class="tip" id="fs28">val tanh : value:&#39;T -&gt; &#39;T (requires member Tanh)<br /><br />Full name: Microsoft.FSharp.Core.Operators.tanh</div>

        </div>
        <div class="span3">
          <!-- <img src="http://www.deepml.net/img/logo.png" alt="Deep.Net logo" style="width:150px;margin:10px" /> -->  
          <ul class="nav nav-list" id="menu" style="margin-top: 20px;">
            <li class="nav-header">Deep.Net</li>
            <li><a href="http://www.deepml.net/index.html">Home page</a></li>
            <li class="divider"></li>
            <li><a href="http://nuget.org/packages/DeepNet">Get Library via NuGet</a></li>
            <li><a href="http://github.com/DeepMLNet/DeepNet">Source Code on GitHub</a></li>
            <li><a href="http://www.deepml.net/release-notes.html">Release Notes</a></li>
            
            <li class="nav-header">Getting started</li>
            <li><a href="http://www.deepml.net/tensor.html">Working with Tensors</a></li>
            <li><a href="http://www.deepml.net/mnist.html">Learning MNIST</a></li>
            <li><a href="http://www.deepml.net/blocks.html">Model Components</a></li>

            <li class="nav-header">Documentation</li>
            <li><a href="http://www.deepml.net/reference/index.html">API Reference</a></li>
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/DeepMLNet/DeepNet"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"/></a>
  </body>
  </html>
